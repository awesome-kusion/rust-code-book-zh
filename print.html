<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rustæºç å‰–æ</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="é€šè¿‡åˆ†æä»£ç å­¦ä¹ Rust">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
                <link rel="stylesheet" href="style.css">
        
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="preface.html">åºè¨€</a></li><li class="chapter-item expanded "><a href="intro/index.html"><strong aria-hidden="true">1.</strong> ç®€ä»‹</a></li><li class="chapter-item expanded "><a href="stdlib/index.html"><strong aria-hidden="true">2.</strong> æ ‡å‡†åº“</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="stdlib/sort/index.html"><strong aria-hidden="true">2.1.</strong> æ’åºç®—æ³•: Timsort å’Œ pdqsort</a></li></ol></li><li class="chapter-item expanded "><a href="rustc/index.html"><strong aria-hidden="true">3.</strong> Rustç¼–è¯‘å™¨</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rustc/overview/index.html"><strong aria-hidden="true">3.1.</strong> æ¦‚è¿°</a></li><li class="chapter-item expanded "><a href="rustc/invocation/index.html"><strong aria-hidden="true">3.2.</strong> å‘½ä»¤è¡Œè§£æ</a></li><li class="chapter-item expanded "><a href="rustc/lexer/index.html"><strong aria-hidden="true">3.3.</strong> è¯æ³•åˆ†æ</a></li><li class="chapter-item expanded "><a href="rustc/parser/index.html"><strong aria-hidden="true">3.4.</strong> è¯­æ³•åˆ†æ</a></li><li class="chapter-item expanded "><a href="rustc/sema/index.html"><strong aria-hidden="true">3.5.</strong> è¯­ä¹‰åˆ†æ</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rustc/sema/lint/index.html"><strong aria-hidden="true">3.5.1.</strong> Lint</a></li></ol></li><li class="chapter-item expanded "><a href="rustc/codegen/index.html"><strong aria-hidden="true">3.6.</strong> ä»£ç ç”Ÿæˆ</a></li><li class="chapter-item expanded "><a href="rustc/general/index.html"><strong aria-hidden="true">3.7.</strong> é€šç”¨ç»“æ„</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rustc/general/errors/index.html"><strong aria-hidden="true">3.7.1.</strong> Rust é”™è¯¯ä¿¡æ¯è¾“å‡ºåŸç†æ¦‚è¿°</a></li><li class="chapter-item expanded "><a href="rustc/general/sourcemap-span/index.html"><strong aria-hidden="true">3.7.2.</strong> SourceMap &amp; Span[WIP]</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="rust-tools/index.html"><strong aria-hidden="true">4.</strong> Rustå¤–å›´å·¥å…·</a></li><li class="chapter-item expanded "><a href="open-source/index.html"><strong aria-hidden="true">5.</strong> Rustå¼€æºé¡¹ç›®</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="open-source/KCLVM/index.html"><strong aria-hidden="true">5.1.</strong> KCLVM</a></li></ol></li><li class="chapter-item expanded "><a href="appendix/index.html"><strong aria-hidden="true">6.</strong> é™„å½•</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Rustæºç å‰–æ</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/awesome-kusion/rust-code-book-zh" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <!-- Page table of contents -->
                    <div class="sidetoc"><nav class="pagetoc"></nav></div>
                    <main>
                        <!-- å¤´éƒ¨ -->
                                                
                        <h1 id="åºè¨€"><a class="header" href="#åºè¨€">åºè¨€</a></h1>
<p>å†™è¿™ä¸ªç”µå­ä¹¦æ˜¯å› ä¸ºä¸€å¼€å§‹åœ¨åš KusionStackã€KCLVM é¡¹ç›®ä¸­ç¼–è¯‘å™¨ç ”å‘çš„ç›¸å…³å·¥ä½œï¼Œæœ¬ç€å­¦ä¹ ä¼˜ç§€ç¼–è¯‘å™¨çš„è®¾è®¡æƒ³æ³•ï¼Œå¼€å§‹å­¦ä¹  Rustc çš„æºç ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­è®°å½•äº†ä¸€äº›ç¬”è®°å’Œæ–‡æ¡£ï¼Œåœ¨<a href="https://github.com/chai2010">æŸ´å¤§</a>çš„å»ºè®®ä¸‹æ•´ç†æˆæ–‡ç« æ­£å¼å‘åœ¨äº†å…¬ä¼—å·ä¸Šã€‚æ²¡æƒ³åˆ°å¾ˆå—æ¬¢è¿ï¼Œäºæ˜¯å†³å®šåšæŒå†™ä¸‹å»ã€‚æ¥ä¸‹æ¥ä¼šå»å†™ä¸€äº› Rustc ä¸­çš„æºç å®ç°ã€æ ‡å‡†åº“ã€å·¥å…·ï¼Œä»¥åŠä¸€äº› Rust çš„å¼€æºé¡¹ç›®ã€‚</p>
<p>KCLVM æ˜¯æˆ‘ä»¬åœ¨ Kusion è¿™ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨ Rust å¼€å‘çš„è¯­è¨€ç¼–è¯‘å™¨ï¼Œä¹¦ä¸­çš„éƒ¨åˆ†å†…å®¹åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ä¹Ÿæœ‰å¯¹åº”çš„åº”ç”¨ã€‚å¯¹äº‘åŸç”Ÿç”Ÿæ€ã€æŠ€æœ¯æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥äº†è§£ä¸‹  ğŸ‘‰ <a href="https://github.com/KusionStack/kusion">KusionStack</a> è¿™ä¸ªé¡¹ç›®ï¼›å¯¹ Rustã€ç¼–ç¨‹è¯­è¨€ã€ç¼–è¯‘å™¨æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹ ğŸ‘‰ <a href="https://github.com/KusionStack/KCLVM">KCLVM</a>ã€‚</p>
<p>æœ€åï¼Œè¿™äº›æ–‡ç« ä¸­çš„å†…å®¹å¤§éƒ¨åˆ†æ˜¯æˆ‘é˜…è¯»æºç æ—¶çš„ä¸€äº›è®°å½•å’Œä¸ªäººç†è§£ï¼Œä»¥åŠ <a href="https://rustc-dev-guide.rust-lang.org/about-this-guide.html">rust-dev-guide</a> ä¸­å¯¹åº”çš„ä¸€äº›æè¿°ã€‚æœ¬äººæ°´å¹³æœ‰é™ï¼Œæ‰€ä»¥å¯èƒ½ä¼šæœ‰ä¸€äº›ä¸å‡†ç¡®ç”šè‡³é”™è¯¯çš„åœ°æ–¹ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶æ PR/Issue/Discussionï¼Œæˆ–è€…ä¸‹æ–¹æ‰«ç åŠ ç¾¤è®¨è®ºã€‚å¦‚æœå¯¹ Rust æºç æœ‰è‡ªå·±åˆ†æå’Œè§è§£ï¼ŒåŒæ ·æ¬¢è¿æ PR æŠ•ç¨¿ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç®€ä»‹"><a class="header" href="#ç®€ä»‹">ç®€ä»‹</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ ‡å‡†åº“"><a class="header" href="#æ ‡å‡†åº“">æ ‡å‡†åº“</a></h1>
<ul>
<li><a href="https://awesome-kusion.github.io/rust-code-book/open-source/KCLVM/index.html">æ’åºç®—æ³•: Timsort å’Œ pdqsort</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ’åºç®—æ³•-timsort-å’Œ-pdqsort"><a class="header" href="#æ’åºç®—æ³•-timsort-å’Œ-pdqsort">æ’åºç®—æ³•: Timsort å’Œ pdqsort</a></h1>
<h2 id="å‰è¨€"><a class="header" href="#å‰è¨€">å‰è¨€</a></h2>
<p>Rust ä¸­æ’åºç®—æ³•çš„å®ç°å¯ä»¥åˆ†ä¸ºç¨³å®šå’Œä¸ç¨³å®šçš„ä¸¤ç±»ã€‚å…¶ä¸­ç¨³å®šçš„æ’åºç®—æ³•æ˜¯ä¸€ç§å— Tim Peters çš„ <a href="https://en.wikipedia.org/wiki/Timsort">Timsort</a> ç®—æ³•å¯å‘çš„è‡ªé€‚åº”ã€è¿­ä»£å½’å¹¶æ’åºï¼›è€Œä¸ç¨³å®šçš„æ’åºç®—æ³•åˆ™æ˜¯åŸºäº Orson Peters çš„ <a href="https://github.com/orlp/pdqsort">pdqsort</a>[pattern-defeating quicksort]ã€‚æœ¬æ–‡å°†ä»‹ç»è¿™ä¸¤ä¸ªç®—æ³•åœ¨ Rust ä¸­çš„å®ç°ã€‚</p>
<h2 id="ç¨³å®šæ’åº-timsort"><a class="header" href="#ç¨³å®šæ’åº-timsort">ç¨³å®šæ’åºï¼š Timsort</a></h2>
<p>ç¨³å®šæ’åºæ˜¯æŒ‡åœ¨æ’åºè¿‡ç¨‹ä¸­ä¸æ”¹å˜ç›¸ç­‰çš„å…ƒç´ çš„é¡ºåºã€‚ Rust ä¸­çš„ç¨³å®šæ’åºçš„å®ç°æ˜¯ä¸€ç§æ”¹è¿›çš„ timsort ç®—æ³•ã€‚å¯ä»¥åœ¨ <code>libray:alloc:src:slice.rs</code> ä¸­çœ‹åˆ°å®ƒçš„å®ç°ã€‚</p>
<h3 id="timsort-ç®€ä»‹"><a class="header" href="#timsort-ç®€ä»‹">Timsort ç®€ä»‹</a></h3>
<p>Timsort ç®—æ³•ç”± Tim Peters åœ¨ 2002 å¹´è®¾è®¡ï¼Œæ˜¯ä¸€ç§å½’å¹¶å’Œæ’å…¥æ’åºçš„æ··åˆçš„æ’åºç®—æ³•ã€‚åœ¨æœ€åçš„æƒ…å†µï¼Œå®ƒçš„æ—¶é—´å¤æ‚åº¦ä¸º <em>O</em>(<em>n</em> * log(<em>n</em>))ï¼Œéœ€è¦åˆ†é…æ’åºçš„æ•°ç»„ä¸€åŠå¤§å°çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥ç©ºé—´å¤æ‚åº¦ä¸º <em>O</em>(<em>n</em>)ï¼Œæ‰€ä»¥åœ¨å„ä¸ªæ–¹é¢éƒ½ä¼˜äº<em>O</em>(<em>n</em>)ç©ºé—´å’Œç¨³å®š<em>O</em>(<em>n</em> * log(<em>n</em>))æ—¶é—´çš„å½’å¹¶æ’åºç®—æ³•ã€‚ç”±äºå…¶å‡ºè‰²çš„æ€§èƒ½ï¼Œåœ¨ Python ä¸­æœ€å…ˆå¼•å…¥ï¼Œä½œä¸º list.sort çš„é»˜è®¤å®ç°ï¼Œåç»­ Java ä¹Ÿåœ¨ JDK1.7 ä¸­ä½¿ç”¨äº† Timsort ç®—æ³•ã€‚</p>
<p>Timsort ç®—æ³•çš„åŸºæœ¬æµç¨‹æ˜¯ï¼š</p>
<ol>
<li>ç¡®å®šæ•°ç»„çš„å•è°ƒä¸Šå‡æ®µå’Œä¸¥æ ¼å•è°ƒä¸‹é™æ®µï¼Œå¹¶å°†ä¸¥æ ¼ä¸‹é™æ®µåè½¬</li>
<li>å®šä¹‰æœ€å°ç‰‡æ®µ(run)é•¿åº¦ï¼Œä½äºæ­¤é•¿åº¦çš„ç‰‡æ®µé€šè¿‡æ’å…¥æ’åºåˆå¹¶åˆ°è¾ƒé•¿çš„æ®µä¸­</li>
<li>åå¤å½’å¹¶ç›¸é‚»ç‰‡æ®µï¼Œç›´åˆ°æ•´ä¸ªæ’åºå®Œæˆ</li>
</ol>
<p>å› æ­¤ï¼ŒTimsort åŸºæœ¬ä¸Šæ˜¯ä¸€ç§å½’å¹¶æ’åºï¼Œä½†æ˜¯åœ¨ä¸€äº›å°ç‰‡æ®µçš„åˆå¹¶ä¸­ä½¿ç”¨äº†æ’å…¥æ’åºã€‚</p>
<h3 id="ç®—æ³•å®ç°"><a class="header" href="#ç®—æ³•å®ç°">ç®—æ³•å®ç°</a></h3>
<p>å¯ä»¥åœ¨ <code>libray:alloc:src:slice.rs</code> ä¸­çœ‹åˆ° Rust ä¸­ Timsort ç®—æ³•çš„å®ç°ã€‚</p>
<h4 id="ç©ºæ•°ç»„å’ŒçŸ­æ•°ç»„å¤„ç†"><a class="header" href="#ç©ºæ•°ç»„å’ŒçŸ­æ•°ç»„å¤„ç†">ç©ºæ•°ç»„å’ŒçŸ­æ•°ç»„å¤„ç†</a></h4>
<p>é¦–å…ˆæ˜¯ä¸€äº›ç‰¹æ®Šæƒ…å†µçš„å¤„ç†ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn merge_sort&lt;T, F&gt;(v: &amp;mut [T], mut is_less: F)
where
    F: FnMut(&amp;T, &amp;T) -&gt; bool,
{
    // Slices of up to this length get sorted using insertion sort.
    const MAX_INSERTION: usize = 20;
        // Sorting has no meaningful behavior on zero-sized types.
    if T::IS_ZST {
        return;
    }
    let len = v.len();
    // Short arrays get sorted in-place via insertion sort to avoid allocations.
    if len &lt;= MAX_INSERTION {
        if len &gt;= 2 {
            for i in (0..len - 1).rev() {
                insert_head(&amp;mut v[i..], &amp;mut is_less);
            }
        }
        return;
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>è¿™æ®µéå¸¸å®¹æ˜“ç†è§£ï¼Œå¦‚æœæ˜¯ç©ºæ•°ç»„å°±ç›´æ¥è¿”å›ï¼›å¦‚æœæ˜¯æ¯”è¾ƒçŸ­çš„æ•°ç»„ï¼ˆä½äº20ï¼‰ï¼Œå°±ç›´æ¥ç”¨ç®€å•çš„æ’å…¥æ’åºã€‚</p>
<h4 id="æ‰«ææ•°ç»„ç¡®å®šå•è°ƒç‰‡æ®µ"><a class="header" href="#æ‰«ææ•°ç»„ç¡®å®šå•è°ƒç‰‡æ®µ">æ‰«ææ•°ç»„ï¼Œç¡®å®šå•è°ƒç‰‡æ®µ</a></h4>
<p>Timsort ç®—æ³•çš„ç¬¬ä¸€æ­¥æ˜¯è¯†åˆ«å•è°ƒç‰‡æ®µ(run)ï¼šå•è°ƒé€’å¢ç‰‡æ®µå’Œä¸¥æ ¼å•è°ƒé€’å‡ç‰‡æ®µï¼Œå¹¶å°†ä¸¥æ ¼å•è°ƒé€’å‡ç‰‡æ®µåè½¬ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn merge_sort&lt;T, F&gt;(v: &amp;mut [T], mut is_less: F)
where
    F: FnMut(&amp;T, &amp;T) -&gt; bool,
{
    let mut end = len;
    while end &gt; 0 {
        let mut start = end - 1;
        if start &gt; 0 {
            start -= 1;
            unsafe {
                if is_less(v.get_unchecked(start + 1), v.get_unchecked(start)) {
                    while start &gt; 0 &amp;&amp; is_less(v.get_unchecked(start), v.get_unchecked(start - 1)) {
                        start -= 1;
                    }
                    v[start..end].reverse();
                } else {
                    while start &gt; 0 &amp;&amp; !is_less(v.get_unchecked(start), v.get_unchecked(start - 1))
                    {
                        start -= 1;
                    }
                }
            }
        }
    ...
    }
}


<span class="boring">}
</span></code></pre></pre>
<p>é¦–å…ˆä»åå‘å‰éå†æ•°ç»„ï¼Œæ‰¾åˆ°å•è°ƒé€’å¢æˆ–ä¸¥æ ¼å•è°ƒé€’å‡çš„æ®µçš„èµ·ç‚¹ï¼Œå¹¶å°†ä¸¥æ ¼å•è°ƒé€’å‡çš„æ®µåè½¬ã€‚ä»¥æ•°ç»„<code>[4ï¼Œ5ï¼Œ6, 7, 3(1), 3(2), 1, 0]</code>ä¸ºä¾‹ï¼ˆä¸ºäº†ç®€åŒ–æ©é¥°ï¼Œæš‚ä¸è€ƒè™‘<code>MAX_INSERTION</code>ï¼‰ï¼Œé¦–å…ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸¥æ ¼å•è°ƒé€’å‡æ®µ<code>[3(2), 1, 0]</code>ï¼Œå¹¶å°†å…¶åè½¬ä¸º<code>[0, 1, 3(2)]</code>ã€‚</p>
<h4 id="åˆå¹¶è¾ƒçŸ­çš„æ®µ"><a class="header" href="#åˆå¹¶è¾ƒçŸ­çš„æ®µ">åˆå¹¶è¾ƒçŸ­çš„æ®µ</a></h4>
<p>åœ¨è¾ƒçŸ­çš„æ•°ç»„ä¸Šï¼Œæ’å…¥æ’åºçš„æ€§èƒ½ä¼˜äºå½’å¹¶æ’åºã€‚æ‰€ä»¥ Timsort ç®—æ³•çš„ç¬¬äºŒæ­¥æ˜¯å®šä¹‰æœ€çŸ­æ®µé•¿åº¦ï¼Œå¹¶åˆ©ç”¨æ’å…¥æ’åºåˆå¹¶è¾ƒçŸ­çš„æ®µã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn merge_sort&lt;T, F&gt;(v: &amp;mut [T], mut is_less: F)
where
    F: FnMut(&amp;T, &amp;T) -&gt; bool,
{
    const MIN_RUN: usize = 10;
    while end &gt; 0 {
        // omit step 1

        while start &gt; 0 &amp;&amp; end - start &lt; MIN_RUN {
            start -= 1;
            insert_head(&amp;mut v[start..end], &amp;mut is_less);
        }
        runs.push(Run { start, len: end - start });
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>ä¸Šè¿°çš„ä¾‹å­ä¸­ï¼ŒåŒæ ·ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œå‡è®¾ <code>MIN_RUN</code> çš„å€¼ä¸º5ã€‚åˆ™æ ¹æ®ä¸Šè¿°ä»£ç ï¼Œä½¿ç”¨æ’å…¥æ’åºåœ¨æ®µä¸­æ’å…¥ <code>7</code> å’Œ <code>3(1)</code>ï¼Œåˆ™æ®µå˜ä¸º <code>[0, 1, 3(1), 3(2), 7]</code>ã€‚æœ€åå°†è¿™ä¸ªæ®µå…¥æ ˆã€‚</p>
<h4 id="åˆå¹¶ç›¸é‚»æ®µ"><a class="header" href="#åˆå¹¶ç›¸é‚»æ®µ">åˆå¹¶ç›¸é‚»æ®µ</a></h4>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn merge_sort&lt;T, F&gt;(v: &amp;mut [T], mut is_less: F)
where
    F: FnMut(&amp;T, &amp;T) -&gt; bool,
{
    const MIN_RUN: usize = 10;
    while end &gt; 0 {
        // omit step 1 and step 2
        while let Some(r) = collapse(&amp;runs) {
            let left = runs[r + 1];
            let right = runs[r];
            unsafe {
                merge(
                    &amp;mut v[left.start..right.start + right.len],
                    left.len,
                    buf.as_mut_ptr(),
                    &amp;mut is_less,
                );
            }
            runs[r] = Run { start: left.start, len: left.len + right.len };
            runs.remove(r + 1);
        }
    }
    fn collapse(runs: &amp;[Run]) -&gt; Option&lt;usize&gt; {
        let n = runs.len();
        if n &gt;= 2
            &amp;&amp; (runs[n - 1].start == 0
                || runs[n - 2].len &lt;= runs[n - 1].len
                || (n &gt;= 3 &amp;&amp; runs[n - 3].len &lt;= runs[n - 2].len + runs[n - 1].len)
                || (n &gt;= 4 &amp;&amp; runs[n - 4].len &lt;= runs[n - 3].len + runs[n - 2].len))
        {
            if n &gt;= 3 &amp;&amp; runs[n - 3].len &lt; runs[n - 1].len { Some(n - 3) } else { Some(n - 2) }
        } else {
            None
        }
    }

}
<span class="boring">}
</span></code></pre></pre>
<p>é¦–å…ˆçœ‹ <code>collapse</code> å‡½æ•°ã€‚è¿™é‡Œç”¨ <code>collapse</code> åˆ¤æ–­æ˜¯å¦æœ‰èƒ½å¤Ÿåˆå¹¶çš„æ®µï¼Œå¦‚æœæœ‰ï¼Œåˆ™è¿”å›å…¶ä¸‹æ ‡ <code>r</code>ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿”å› <code>None</code>ã€‚å…·ä½“åˆ¤æ–­çš„é€»è¾‘ç¨åè¯´æ˜ã€‚</p>
<p>æ­¥éª¤3ä¸­æ ¹æ® <code>collapse</code> å‡½æ•°çš„è¿”å›ç»“æœï¼Œä½¿ç”¨å½’å¹¶æ’åºåˆå¹¶ <code>runs[r]</code>å’Œ <code>runs[r + 1]</code>ï¼Œæˆ–è€…é‡å¤æ­¥éª¤ 1 å’Œæ­¥éª¤ 2ï¼Œç»§ç»­åœ¨æ ˆ <code>runs</code> ä¸­æ„å»ºæ–°çš„æ®µã€‚</p>
<p>åˆšåˆšçš„ä¾‹å­ä¸­ï¼Œæ ˆ <code>runs</code> ä¸­åªæœ‰ä¸€ä¸ªæ®µ <code>[0, 1, 3(1), 3(2), 7]</code>ï¼Œæ˜¾ç„¶ä¸èƒ½åˆå¹¶ï¼Œå› æ­¤é‡å¤æ­¥éª¤ 1 å’Œæ­¥éª¤ 2ï¼Œåœ¨ <code>runs</code> ä¸­æ·»åŠ ç¬¬äºŒä¸ªæ®µï¼Œä½¿å…¶å˜ä¸º <code>[[0, 1, 3(1), 3(2), 7], [4, 5, 6]]</code>(ç”¨ <code>[]</code> è¡¨ç¤ºä¸€ä¸ªæ®µ)ã€‚æ­¤æ—¶ <code>collapse</code> ä¼šè¿”å›ä¸‹æ ‡ <code>0</code>ï¼Œç„¶åä½¿ç”¨å½’å¹¶åˆå¹¶ <code>[0, 1, 3(1), 3(2), 7]</code> å’Œ <code>[4, 5, 6]</code>ã€‚å¾—åˆ°ç»“æœ <code>[0, 1, 3(1), 3(2), 4, 5, 6, 7]</code>ï¼Œå®Œæˆæ•´ä¸ªéå†ã€‚</p>
<h3 id="ä¸-timsort-ç®—æ³•çš„åŒºåˆ«"><a class="header" href="#ä¸-timsort-ç®—æ³•çš„åŒºåˆ«">ä¸ Timsort ç®—æ³•çš„åŒºåˆ«</a></h3>
<p>Rust ä¸­çš„å®ç°å¹¶éé»˜è®¤çš„ Timsort çš„ç®—æ³•ï¼Œè¿™æ˜¯å› ä¸º Timsort ç®—æ³•å­˜åœ¨ bug(http://envisage-project.eu/timsort-specification-and-verification/)ã€‚Rust çš„å®ç°åœ¨ <code>collapse</code> è¿™ä¸ªå‡½æ•°åšäº†ä¿®æ”¹ã€‚</p>
<p>å¯ä»¥æ¯”è¾ƒ Java JDK1.8ä¸­å¯¹åº”çš„å®ç°ã€‚Javaçš„å®ç°ä¸­åªæ¯”è¾ƒäº†æ ˆé¡¶3ä¸ªå…ƒç´ ï¼Œä½† Rust çš„ç°å®æ¯”è¾ƒäº†æ ˆé¡¶ 4 ä¸ªå…ƒç´ ã€‚</p>
<pre><code class="language-java">private void mergeCollapse() {
    while (stackSize &gt; 1) {
        int n = stackSize - 2;
        if (n &gt; 0 &amp;&amp; runLen[n - 1] &lt;= runLen[n] + runLen[n + 1]) {
            if (runLen[n - 1] &lt; runLen[n + 1])
                n--;
            mergeAt(n);
        } else if (runLen[n] &lt;= runLen[n + 1]) {
            mergeAt(n);
        } else {
            break; // Invariant is established
        }
    }
}
</code></pre>
<p>å‡ºäºæ€§èƒ½åŸå› ï¼ŒTimsort è¦ç»´æŠ¤å°½å¯èƒ½å°‘çš„ runã€‚å› æ­¤åœ¨æ¯æ¬¡æ–°çš„ <code>run</code> å…¥æ ˆæ—¶ï¼Œä¼šè¿è¡Œ <code>mergeCollapse</code> å‡½æ•°åˆå¹¶æ ˆé¡¶ 3 ä¸ªå…ƒç´ ,åˆå› ä¸ºæ¯æ¬¡å…¥æ ˆéƒ½ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥æ ˆä¸­æ‰€æœ‰ run çš„é•¿åº¦éƒ½æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ol>
<li>runLen[n - 2] &gt; runLen[n - 1] + runLen[n]</li>
<li>runLen[n - 1] &gt; runLen[n]</li>
</ol>
<p>å¦‚æœä¸æ»¡è¶³è§„åˆ™ 1ï¼Œåˆ™å°† run[n - 1] ä¸ run[n] å’Œ run[n - 2] è¾ƒçŸ­çš„åˆå¹¶ã€‚ä¾‹å¦‚ï¼Œruns ä¸­å­˜åœ¨ä¸¤ä¸ªé•¿åº¦åˆ†åˆ«ä¸º 12 å’Œ 7 çš„ runï¼Œæ­¤æ—¶å…¥æ ˆä¸€ä¸ªé•¿åº¦ä¸º 6 çš„runï¼Œåˆ™åˆå¹¶é•¿åº¦ä¸º 7 å’Œ 6 ä¸¤ä¸ª runï¼Œæ ˆå˜ä¸º [12, 13]ã€‚
å¦‚æœä¸æ»¡è¶³è§„åˆ™ 2ï¼Œåˆ™å°† run[n - 1] ä¸ run[n] åˆå¹¶ã€‚å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œç»§ç»­åˆå¹¶ 12 å’Œ 13ï¼Œæ­¤æ—¶ runs ä¸­ä»…å‰©ä¸€ä¸ªé•¿åº¦ä¸º 25 çš„ runã€‚å°±å¯ä»¥ç»§ç»­æ‰§è¡Œ Timsort ç®—æ³•çš„ç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥æ„é€ æ–°çš„ run æˆ–å®Œæˆæ’åºã€‚</p>
<p>ä½†é—®é¢˜åœ¨å“ªå‘¢ï¼Ÿè€ƒè™‘ä¸€ä¸ªä¾‹å­ï¼š</p>
<pre><code>120, 80, 25, 20, 30
</code></pre>
<p>å› ä¸º 25 &lt; 20 + 30ï¼Œ æ‰€ä»¥åˆå¹¶ä¸º</p>
<pre><code>120, 80, 45, 30
</code></pre>
<p>æ­¤æ—¶ï¼Œ <code>120, 80, 45</code> å·²ç»ä¸æ»¡è¶³è§„åˆ™ã€‚è¿™ä¸ªbugåœ¨<a href="http://www.envisage-project.eu/proving-android-java-and-python-sorting-algorithm-is-broken-and-how-to-fix-it">è¿™é‡Œ</a>æœ‰æ›´ä¸ºè¯¦ç»†çš„æè¿°ä»¥åŠè§£å†³æ–¹æ³•ã€‚</p>
<h2 id="ä¸ç¨³å®šæ’åº-pdqsort"><a class="header" href="#ä¸ç¨³å®šæ’åº-pdqsort">ä¸ç¨³å®šæ’åºï¼š pdqsort</a></h2>
<p>todo</p>
<h2 id="ref"><a class="header" href="#ref">Ref</a></h2>
<p>Timsort: https://github.com/python/cpython/blob/main/Objects/listsort.txt
OpenJDKâ€™s java.utils.Collection.sort() is broken: The good, the bad and the worst case: http://envisage-project.eu/timsort-specification-and-verification/
Proving that Androidâ€™s, Javaâ€™s and Pythonâ€™s sorting algorithm is broken (and showing how to fix it): http://www.envisage-project.eu/proving-android-java-and-python-sorting-algorithm-is-broken-and-how-to-fix-it/
java bug track: https://bugs.openjdk.org/browse/JDK-8072909</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rustç¼–è¯‘å™¨"><a class="header" href="#rustç¼–è¯‘å™¨">Rustç¼–è¯‘å™¨</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åŸºç¡€ç»“æ„"><a class="header" href="#åŸºç¡€ç»“æ„">åŸºç¡€ç»“æ„</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å‘½ä»¤è¡Œè§£æ"><a class="header" href="#å‘½ä»¤è¡Œè§£æ">å‘½ä»¤è¡Œè§£æ</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è¯æ³•åˆ†æ"><a class="header" href="#è¯æ³•åˆ†æ">è¯æ³•åˆ†æ</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è¯­æ³•åˆ†æ"><a class="header" href="#è¯­æ³•åˆ†æ">è¯­æ³•åˆ†æ</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è¯­ä¹‰åˆ†æ"><a class="header" href="#è¯­ä¹‰åˆ†æ">è¯­ä¹‰åˆ†æ</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="lint"><a class="header" href="#lint">Lint</a></h1>
<h2 id="èƒŒæ™¯"><a class="header" href="#èƒŒæ™¯">èƒŒæ™¯</a></h2>
<h3 id="lint-å·¥å…·"><a class="header" href="#lint-å·¥å…·">Lint å·¥å…·</a></h3>
<p>Lint æ˜¯ä»£ç é™æ€åˆ†æå·¥å…·çš„ä¸€ç§ï¼Œæœ€æ—©æ˜¯æ¥æºäº C è¯­è¨€ã€‚Lint å·¥å…·é€šå¸¸ä¼šæ£€æŸ¥ä»£ç ä¸­æ½œåœ¨çš„é—®é¢˜å’Œé”™è¯¯ï¼ŒåŒ…æ‹¬ï¼ˆä½†ä¸é™äºï¼‰ç¼–ç¨‹é£æ ¼ï¼ˆç¼©è¿›ã€ç©ºè¡Œã€ç©ºæ ¼ï¼‰ã€ä»£ç è´¨é‡ï¼ˆå®šä¹‰æœªä½¿ç”¨çš„å˜é‡ã€æ–‡æ¡£ç¼ºå¤±ï¼‰ä»¥åŠé”™è¯¯ä»£ç ï¼ˆé™¤0é”™è¯¯ã€é‡å¤å®šä¹‰ã€å¾ªç¯å¼•ç”¨ï¼‰ç­‰é—®é¢˜ã€‚é€šå¸¸æ¥è¯´ï¼ŒLint å·¥å…·é™¤äº†æ ‡è¯†é”™è¯¯å¤–ï¼Œè¿˜ä¼šå¸¦æœ‰ä¸€å®šçš„ fix/refactor suggest å’Œ auto-fix çš„èƒ½åŠ›ã€‚åœ¨å·¥ç¨‹ä¸­å¼•å…¥ Lint å·¥å…·å¯ä»¥æœ‰æ•ˆçš„å‡å°‘é”™è¯¯ï¼Œæé«˜æ•´ä½“çš„å·¥ç¨‹è´¨é‡ã€‚æ­¤å¤–ï¼Œå¯¹ä¸€ç§ç¼–ç¨‹è¯­è¨€æ¥è¯´ï¼ŒLint å·¥å…·é€šå¸¸ä¹Ÿæ˜¯å…¶ä»–å·¥å…·ç ”å‘çš„å‰ç½®æ¡ä»¶ï¼Œä¾‹å¦‚ IDE æ’ä»¶çš„é”™è¯¯æç¤ºï¼ŒCI çš„ Pipeline æ£€æµ‹ç­‰ã€‚</p>
<h2 id="lint-ä¸-lintpass"><a class="header" href="#lint-ä¸-lintpass">Lint ä¸ LintPass</a></h2>
<h3 id="æ¦‚å¿µä¸å…³ç³»"><a class="header" href="#æ¦‚å¿µä¸å…³ç³»">æ¦‚å¿µä¸å…³ç³»</a></h3>
<p>Rustc ä¸­å…³äº Lint æœ€ä¸»è¦çš„ç»“æ„æœ‰ä¸¤ä¸ªï¼Œ <code>Lint</code> å’Œ <code>LintPass</code>ã€‚é¦–å…ˆéœ€è¦åŒºåˆ† Lint å’Œ LintPass çš„æ¦‚å¿µã€‚Rustc çš„å¾ˆå¤šæ–‡æ¡£ä¸­éƒ½å°†å®ƒä»¬ç»Ÿç§°ä¸º <code>Lint</code>ï¼Œè¿™å¾ˆå®¹æ˜“é€ æˆæ··æ·†ã€‚å…³äºè¿™ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ï¼Œrustc-dev-guide ç»™å‡ºçš„è§£é‡Šæ˜¯ï¼š</p>
<blockquote>
<p>Lint declarations don't carry any &quot;state&quot; - they are merely global identifiers and descriptions of lints. We assert at runtime that they are not registered twice (by lint name).
Lint passes are the meat of any lint.</p>
</blockquote>
<p>ä»å®šä¹‰æ–¹é¢ï¼Œ <code>Lint</code> æ˜¯å¯¹æ‰€å®šä¹‰çš„ lint æ£€æŸ¥çš„é™æ€æè¿°ï¼Œä¾‹å¦‚ name, level, description, code ç­‰å±æ€§ï¼Œä¸æ£€æŸ¥æ—¶çš„çŠ¶æ€æ— å…³ï¼ŒRustc ç”¨ <code>Lint</code> çš„å®šä¹‰åšå”¯ä¸€æ€§çš„æ£€æŸ¥ã€‚è€Œ <code>LintPass</code> æ˜¯ <code>Lint</code> çš„å…·ä½“å®ç°ï¼Œæ˜¯åœ¨æ£€æŸ¥æ—¶è°ƒç”¨çš„ <code>check_*</code> æ–¹æ³•ã€‚
åœ¨å…·ä½“çš„ä»£ç å®ç°æ–¹æ³•ï¼Œ <code>Lint</code>å®šä¹‰ä¸ºä¸€ä¸ª Structï¼Œæ‰€æœ‰ lint çš„å®šä¹‰éƒ½æ˜¯æ­¤ç±»å‹çš„ä¸€ä¸ªå®ä¾‹/å¯¹è±¡ã€‚è€Œ <code>LintPass</code> åˆ™å¯¹åº”ä¸ºä¸€ä¸ª traitã€‚trait ç±»ä¼¼äº java/c++ ä¸­çš„æ¥å£ï¼Œæ¯ä¸€ä¸ª lintpass çš„å®šä¹‰éƒ½éœ€è¦å®ç°è¯¥æ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Specification of a single lint.
#[derive(Copy, Clone, Debug)]
pub struct Lint {
    pub name: &amp;'static str,
    /// Default level for the lint.
    pub default_level: Level,
    /// Description of the lint or the issue it detects.
    ///
    /// e.g., &quot;imports that are never used&quot;
    pub desc: &amp;'static str,
    ...
}

pub trait LintPass {
    fn name(&amp;self) -&gt; &amp;'static str;
}
<span class="boring">}
</span></code></pre></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå°½ç®¡åˆšåˆšçš„æè¿°ä¸­è¯´åˆ°<code>trait</code> ç±»ä¼¼äºæ¥å£è€Œ <code>Lint</code> æ˜¯ä¸€ä¸ª structï¼Œä½† <code>Lint</code> å’Œ <code>LintPass</code> ä¹‹é—´å¹¶ä¸æ˜¯ OO ä¸­ä¸€ä¸ªâ€œç±»â€å’Œå®ƒçš„â€œæ–¹æ³•â€çš„å…³ç³»ã€‚è€Œæ˜¯åœ¨å£°æ˜ <code>LintPass</code> ä¼šç”Ÿæˆä¸€ä¸ªå®ç°äº†è¯¥ trait çš„åŒåçš„ structï¼Œè¯¥ struct ä¸­çš„ <code>get_lints()</code> æ–¹æ³•ä¼šç”Ÿæˆå¯¹åº”çš„ <code>Lint</code> å®šä¹‰ã€‚</p>
<p><img src="rustc/sema/lint/./images/lint_lintpass.jpeg" alt="lint vs. lintpass" /></p>
<p>è¿™ä¸ rustc-dev-guide çš„æè¿°ä¹Ÿä¿æŒäº†ä¸€è‡´:</p>
<blockquote>
<p>A lint might not have any lint pass that emits it, it could have many, or just one -- the compiler doesn't track whether a pass is in any way associated with a particular lint, and frequently lints are emitted as part of other work (e.g., type checking, etc.).</p>
</blockquote>
<h3 id="lint-ä¸-lintpass-çš„å®å®šä¹‰"><a class="header" href="#lint-ä¸-lintpass-çš„å®å®šä¹‰">Lint ä¸ LintPass çš„å®å®šä¹‰</a></h3>
<p>Rustc ä¸º Lint å’Œ LintPass éƒ½æä¾›äº†ç”¨äºå®šä¹‰å…¶ç»“æ„çš„å®ã€‚
å®šä¹‰ Lint çš„å®<code>declare_lint</code> æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥åœ¨<code>rustc_lint_defs::lib.rs</code>ä¸­æ‰¾åˆ°ã€‚<code>declare_lint</code> å®è§£æè¾“å…¥å‚æ•°ï¼Œå¹¶ç”Ÿæˆåç§°ä¸º <code>$NAME</code> çš„ Lint structã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[macro_export]
macro_rules! declare_lint {
    ($(#[$attr:meta])* $vis: vis $NAME: ident, $Level: ident, $desc: expr) =&gt; (
        $crate::declare_lint!(
            $(#[$attr])* $vis $NAME, $Level, $desc,
        );
    );
    ($(#[$attr:meta])* $vis: vis $NAME: ident, $Level: ident, $desc: expr,
     $(@feature_gate = $gate:expr;)?
     $(@future_incompatible = FutureIncompatibleInfo { $($field:ident : $val:expr),* $(,)*  }; )?
     $($v:ident),*) =&gt; (
        $(#[$attr])*
        $vis static $NAME: &amp;$crate::Lint = &amp;$crate::Lint {
            name: stringify!($NAME),
            default_level: $crate::$Level,
            desc: $desc,
            edition_lint_opts: None,
            is_plugin: false,
            $($v: true,)*
            $(feature_gate: Some($gate),)*
            $(future_incompatible: Some($crate::FutureIncompatibleInfo {
                $($field: $val,)*
                ..$crate::FutureIncompatibleInfo::default_fields_for_macro()
            }),)*
            ..$crate::Lint::default_fields_for_macro()
        };
    );
    ($(#[$attr:meta])* $vis: vis $NAME: ident, $Level: ident, $desc: expr,
     $lint_edition: expr =&gt; $edition_level: ident
    ) =&gt; (
        $(#[$attr])*
        $vis static $NAME: &amp;$crate::Lint = &amp;$crate::Lint {
            name: stringify!($NAME),
            default_level: $crate::$Level,
            desc: $desc,
            edition_lint_opts: Some(($lint_edition, $crate::Level::$edition_level)),
            report_in_external_macro: false,
            is_plugin: false,
        };
    );
}
<span class="boring">}
</span></code></pre></pre>
<p>LintPass çš„å®šä¹‰æ¶‰åŠåˆ°ä¸¤ä¸ªå®ï¼š</p>
<ul>
<li>declare_lint_passï¼šç”Ÿæˆä¸€ä¸ªåä¸º<code>$name</code> çš„ structï¼Œå¹¶ä¸”è°ƒç”¨ <code>impl_lint_pass</code> å®ã€‚</li>
</ul>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>macro_rules! declare_lint_pass {
    ($(#[$m:meta])* $name:ident =&gt; [$($lint:expr),* $(,)?]) =&gt; {
        $(#[$m])* #[derive(Copy, Clone)] pub struct $name;
        $crate::impl_lint_pass!($name =&gt; [$($lint),*]);
    };
}
<span class="boring">}
</span></code></pre></pre>
<ul>
<li>impl_lint_passï¼šä¸ºç”Ÿæˆçš„ <code>LintPass</code> ç»“æ„å®ç°<code>fn name()</code>å’Œ <code>fn get_lints()</code> æ–¹æ³•ã€‚</li>
</ul>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>macro_rules! impl_lint_pass {
    ($ty:ty =&gt; [$($lint:expr),* $(,)?]) =&gt; {
        impl $crate::LintPass for $ty {
            fn name(&amp;self) -&gt; &amp;'static str { stringify!($ty) }
        }
        impl $ty {
            pub fn get_lints() -&gt; $crate::LintArray { $crate::lint_array!($($lint),*) }
        }
    };
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="earlylintpass-ä¸-latelintpass"><a class="header" href="#earlylintpass-ä¸-latelintpass">EarlyLintPass ä¸ LateLintPass</a></h3>
<p>å‰é¢å…³äº <code>LintPass</code> çš„å®ä¹‹ä¸­ï¼Œåªå®šä¹‰äº†<code>fn name()</code>å’Œ <code>fn get_lints()</code> æ–¹æ³•ï¼Œä½†å¹¶æ²¡æœ‰å®šä¹‰ç”¨äºæ£€æŸ¥çš„ <code>check_*</code> å‡½æ•°ã€‚è¿™æ˜¯å› ä¸º Rustc ä¸­å°† <code>LintPass</code> åˆ†ä¸ºäº†æ›´ä¸ºå…·ä½“çš„ä¸¤ç±»ï¼š<code>EarlyLintPass</code>å’Œ<code>LateLintPass</code>ã€‚å…¶ä¸»è¦åŒºåˆ«åœ¨äºæ£€æŸ¥çš„å…ƒç´ æ˜¯å¦å¸¦æœ‰ç±»å‹ä¿¡æ¯ï¼Œå³åœ¨ç±»å‹æ£€æŸ¥ä¹‹å‰è¿˜æ˜¯ä¹‹åæ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œ <code>WhileTrue</code> æ£€æŸ¥ä»£ç ä¸­çš„ <code>while true{...}</code> å¹¶æç¤ºç”¨æˆ·ä½¿ç”¨ <code>loop{...}</code> å»ä»£æ›¿ã€‚è¿™é¡¹æ£€æŸ¥ä¸éœ€è¦ä»»ä½•çš„ç±»å‹ä¿¡æ¯ï¼Œå› æ­¤è¢«å®šä¹‰ä¸ºä¸€ä¸ª Â <code>EarlyLint</code>(ä»£ç ä¸­ <code>impl EarlyLintPass for WhileTrue</code>ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>declare_lint! {
    WHILE_TRUE,
    Warn,
    &quot;suggest using `loop { }` instead of `while true { }`&quot;
}

declare_lint_pass!(WhileTrue =&gt; [WHILE_TRUE]);

impl EarlyLintPass for WhileTrue {
    fn check_expr(&amp;mut self, cx: &amp;EarlyContext&lt;'_&gt;, e: &amp;ast::Expr) {
        ...
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>Rustc ä¸­ç”¨äº†3ä¸ªå®å»å®šä¹‰ <code>EarlyLintPass</code>ï¼š</p>
<ul>
<li>early_lint_methodsï¼šearly_lint_methods ä¸­å®šä¹‰äº† <code>EarlyLintPass</code> ä¸­éœ€è¦å®ç°çš„ <code>check_*</code>å‡½æ•°ï¼Œå¹¶ä¸”å°†è¿™äº›å‡½æ•°ä»¥åŠæ¥æ”¶çš„å‚æ•° <code>$args</code>ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå®ã€‚</li>
</ul>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>macro_rules! early_lint_methods {
    ($macro:path, $args:tt) =&gt; (
        $macro!($args, [
            fn check_param(a: &amp;ast::Param);
            fn check_ident(a: &amp;ast::Ident);
            fn check_crate(a: &amp;ast::Crate);
            fn check_crate_post(a: &amp;ast::Crate);
            ...
        ]);
    )
}
<span class="boring">}
</span></code></pre></pre>
<ul>
<li>declare_early_lint_passï¼šç”Ÿæˆtrait <code>EarlyLintPass</code> å¹¶è°ƒç”¨å® <code>expand_early_lint_pass_methods</code>ã€‚</li>
</ul>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>macro_rules! declare_early_lint_pass {
    ([], [$($methods:tt)*]) =&gt; (
        pub trait EarlyLintPass: LintPass {
            expand_early_lint_pass_methods!(&amp;EarlyContext&lt;'_&gt;, [$($methods)*]);
        }
    )
}
<span class="boring">}
</span></code></pre></pre>
<ul>
<li>expand_early_lint_pass_methodsï¼šä¸º<code>check_*</code>æ–¹æ³•æä¾›é»˜è®¤å®ç°ï¼Œå³ç©ºæ£€æŸ¥ã€‚</li>
</ul>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>macro_rules! expand_early_lint_pass_methods {
    ($context:ty, [$($(#[$attr:meta])* fn $name:ident($($param:ident: $arg:ty),*);)*]) =&gt; (
        $(#[inline(always)] fn $name(&amp;mut self, _: $context, $(_: $arg),*) {})*
    )
}
<span class="boring">}
</span></code></pre></pre>
<p>è¿™æ ·çš„è®¾è®¡å¥½å¤„æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ol>
<li>å› ä¸º LintPass æ˜¯ä¸€ä¸ª traitï¼Œæ¯ä¸€ä¸ª LintPass çš„å®šä¹‰éƒ½éœ€è¦å®ç°å…¶å†…éƒ¨å®šä¹‰çš„æ‰€æœ‰æ–¹æ³•ã€‚ä½† early lint å’Œ late lint å‘ç”Ÿåœ¨ç¼–è¯‘çš„ä¸åŒé˜¶æ®µï¼Œå‡½æ•°å…¥å‚ä¹Ÿä¸ä¸€è‡´ï¼ˆAST å’Œ HIRï¼‰ã€‚å› æ­¤ï¼ŒLintPass çš„å®šä¹‰åªåŒ…å«äº† <code>fn name()</code> å’Œ <code>fn get_lints()</code> è¿™ä¸¤ä¸ªé€šç”¨çš„æ–¹æ³•ã€‚è€Œæ‰§è¡Œæ£€æŸ¥å‡½æ•°åˆ™å®šä¹‰åœ¨äº†æ›´ä¸ºå…·ä½“çš„ <code>EarlyLintPass</code> å’Œ <code>LateLintPass</code> ä¸­ã€‚</li>
<li>åŒæ ·çš„ï¼Œå¯¹äº <code>EarlyLintPass</code>ï¼Œ æ¯ä¸€ä¸ª lintpass çš„å®šä¹‰éƒ½å¿…é¡»å®ç°å…¶ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚ä½†å¹¶éæ¯ä¸€ä¸ª lintpass éƒ½éœ€è¦æ£€æŸ¥ AST çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚ <code>expand_early_lint_pass_methods</code> ä¸ºå…¶å†…éƒ¨æ–¹æ³•æä¾›äº†é»˜è®¤å®ç°ã€‚è¿™æ ·åœ¨å®šä¹‰å…·ä½“çš„ lintpass æ—¶ï¼Œåªéœ€è¦å…³æ³¨å’Œå®ç°å…¶ç›¸å…³çš„æ£€æŸ¥å‡½æ•°å³å¯ã€‚ä¾‹å¦‚ï¼Œå¯¹äº <code>WhileTrue</code> çš„å®šä¹‰ï¼Œå› ä¸º <code>while true { }</code>è¿™æ ·çš„å†™æ³•åªä¼šå‡ºç°åœ¨ <code>ast::Expr</code> èŠ‚ç‚¹ä¸­ï¼Œå› æ­¤åªéœ€è¦å®ç° <code>check_expr</code> å‡½æ•°å³å¯ã€‚åœ¨å…¶ä»–ä»»ä½•èŠ‚ç‚¹è°ƒç”¨ <code>WhileTrue</code> çš„æ£€æŸ¥å‡½æ•°ï¼Œå¦‚åœ¨æ£€æŸ¥ AST ä¸Šçš„æ ‡è¯†ç¬¦èŠ‚ç‚¹æ—¶ï¼Œè°ƒç”¨ <code>WhileTrue.check_ident()</code>ï¼Œåˆ™æ ¹æ®å® <code>expand_early_lint_pass_methods</code> ä¸­çš„å®šä¹‰æ‰§è¡Œä¸€ä¸ªç©ºå‡½æ•°ã€‚</li>
</ol>
<h3 id="pass-çš„å«ä¹‰"><a class="header" href="#pass-çš„å«ä¹‰">pass çš„å«ä¹‰</a></h3>
<p>åœ¨ Rustc ä¸­ï¼Œé™¤äº† <code>Lint</code> å’Œ <code>LintPass</code> å¤–ï¼Œè¿˜æœ‰ä¸€äº› <code>*Pass</code> çš„å‘½åï¼Œå¦‚ <code>Mir</code> å’Œ <code>MirPass</code>ã€<code>rustc_passes</code> åŒ…ç­‰ã€‚ç¼–è¯‘åŸç†é¾™ä¹¦ä¸­å¯¹Passæœ‰å¯¹åº”çš„è§£é‡Šï¼š</p>
<blockquote>
<p>1.2.8 å°†å¤šä¸ªæ­¥éª¤ç»„åˆæˆè¶Ÿ
å‰é¢å…³äºæ­¥éª¤çš„è®¨è®ºè®²çš„æ˜¯ä¸€ä¸ªç¼–è¯‘å™¨çš„é€»è¾‘ç»„ç»‡æ–¹å¼ã€‚åœ¨ä¸€ä¸ªç‰¹å®šçš„å®ç°ä¸­ï¼Œå¤šä¸ªæ­¥éª¤çš„æ´»åŠ¨å¯ä»¥è¢«ç»„åˆæˆä¸€è¶Ÿï¼ˆpassï¼‰ã€‚æ¯è¶Ÿè¯»å…¥ä¸€ä¸ªè¾“å…¥æ–‡ä»¶å¹¶äº§ç”Ÿä¸€ä¸ªè¾“å‡ºæ–‡ä»¶ã€‚</p>
</blockquote>
<p>åœ¨å£°æ˜ <code>LintPass</code> çš„å® <code>declare_lint_pass</code> ä¸­ï¼Œå…¶ç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸€ä¸ªåˆ—è¡¨ï¼Œè¡¨ç¤ºä¸€ä¸ª lintpass å¯ä»¥ç”Ÿæˆå¤šä¸ª lintã€‚Rustc ä¸­è¿˜æœ‰ä¸€äº› CombinedLintPass ä¸­ä¹Ÿæ˜¯å°†æ‰€æœ‰ builtin çš„ lint æ±‡æ€»åˆ°ä¸€ä¸ª lintpass ä¸­ã€‚è¿™ä¸é¾™ä¹¦ä¸­â€œè¶Ÿâ€çš„å®šä¹‰åŸºæœ¬ä¸€è‡´:<code>LintPass</code> å¯ä»¥ç»„åˆå¤šä¸ª <code>Lint</code> çš„æ£€æŸ¥ï¼Œæ¯ä¸ª LintPass è¯»å–ä¸€ä¸ª AST å¹¶äº§ç”Ÿå¯¹åº”çš„ç»“æœã€‚</p>
<h2 id="lint-çš„ç®€å•å®ç°"><a class="header" href="#lint-çš„ç®€å•å®ç°">Lint çš„ç®€å•å®ç°</a></h2>
<p>åœ¨ LintPass çš„å®šä¹‰ä¸­ï¼Œç»™æ¯ä¸€ä¸ª lintpass çš„æ‰€æœ‰ <code>check_*</code> æ–¹æ³•éƒ½æä¾›äº†ä¸€ä¸ªé»˜è®¤å®ç°ã€‚åˆ°è¿™é‡Œä¸ºæ­¢ï¼ŒåŸºæœ¬ä¸Šå·²ç»å¯ä»¥å®ç° Lint æ£€æŸ¥çš„åŠŸèƒ½ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Linter { }
impl ast_visit::Visitor for Linter {
    fn visit_crate(a: ast:crate){
        for lintpass in lintpasses{
            lintpass.check_crate(a)
        }
        walk_crate();
    }
    fn visit_stmt(a: ast:stmt){
        for lintpass in lintpasses{
            lintpass.check_stmt(a)
        }
        walk_stmt();
    }
    ...
}

let linter = Linter::new();

for c in crates{
    linter.visit_crate(c);
}
<span class="boring">}
</span></code></pre></pre>
<p><code>Visitor</code> æ˜¯éå† AST çš„å·¥å…·ï¼Œåœ¨è¿™é‡Œä¸º Linter å®ç°å…¶ä¸­çš„ <code>visit_*</code> æ–¹æ³•ï¼Œåœ¨éå†æ—¶è°ƒç”¨æ‰€æœ‰ lintpass çš„ <code>check_*</code> å‡½æ•°ã€‚<code>walk_*</code> ä¼šç»§ç»­è°ƒç”¨å…¶ä»–çš„ <code>visit_*</code> å‡½æ•°ï¼Œéå†å…¶ä¸­çš„å­èŠ‚ç‚¹ã€‚å› æ­¤ï¼Œå¯¹äºæ¯ä¸€ä¸ª crateï¼Œ åªéœ€è¦è°ƒç”¨ <code>visit_crate()</code> å‡½æ•°å°±å¯ä»¥éå† AST å¹¶å®Œæˆæ£€æŸ¥ã€‚</p>
<h2 id="combinedlintpass"><a class="header" href="#combinedlintpass">CombinedLintpass</a></h2>
<p>ä½†æ˜¯ï¼ŒRustc è‡ªèº«å’Œ clippy æä¾›çš„ Lint å®šä¹‰å¤šè¾¾550+å¤šä¸ªã€‚è€ƒè™‘åˆ°æ€§èƒ½å› ç´ ï¼Œå®šä¹‰å¤§é‡çš„ LintPassï¼Œåˆ†åˆ«æ³¨å†Œå’Œè°ƒç”¨æ˜¾ç„¶æ˜¯ä¸åˆé€‚çš„ã€‚Rustc æä¾›äº†ä¸€ç§æ›´ä¼˜çš„è§£å†³æ–¹æ³•ï¼šæ—¢ç„¶å¯ä»¥å°†å¤šä¸ª Lint ç»„ç»‡ä¸ºä¸€ä¸ª LintPassï¼ŒåŒæ ·ä¹Ÿå¯ä»¥å°†å¤šä¸ª LintPass ç»„åˆæˆä¸€ä¸ª CombinedLintPassã€‚</p>
<blockquote>
<p><a href="https://rustc-dev-guide.rust-lang.org/diagnostics/lintstore.html#compiler-lint-passes-are-combined-into-one-pass">Compiler lint passes are combined into one pass</a>
Within the compiler, for performance reasons, we usually do not register dozens of lint passes. Instead, we have a single lint pass of each variety (e.g., BuiltinCombinedModuleLateLintPass) which will internally call all of the individual lint passes; this is because then we get the benefits of static over dynamic dispatch for each of the (often empty) trait methods.
Ideally, we'd not have to do this, since it adds to the complexity of understanding the code. However, with the current type-erased lint store approach, it is beneficial to do so for performance reasons.</p>
</blockquote>
<h3 id="builtincombinedearlylintpass"><a class="header" href="#builtincombinedearlylintpass">BuiltinCombinedEarlyLintPass</a></h3>
<p>CombinedLintPass åŒæ ·åˆ†ä¸º early å’Œ late ä¸¤ç±»ã€‚ ä»¥ builtin çš„ early lint ä¸ºä¾‹ï¼ŒRustc åœ¨ <code>rustc_lint::src::lib.rs</code> ä¸­ä¸ºè¿™äº› lintpass å®šä¹‰äº†ä¸€ä¸ª <code>BuiltinCombinedEarlyLintPass</code> ç»“æ„ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>early_lint_passes!(declare_combined_early_pass, [BuiltinCombinedEarlyLintPass]);
<span class="boring">}
</span></code></pre></pre>
<p>è™½ç„¶è¿™ä¸ªå®šä¹‰çœ‹èµ·æ¥åªæœ‰ä¸€è¡Œï¼Œä½†å…¶ä¸­é€šè¿‡è‹¥å¹²ä¸ªå®çš„å±•å¼€ï¼Œæ±‡æ€»äº†14ä¸ª <code>LintPass</code>ï¼Œå¹¶ä¸”æ¯ä¸ª <code>LintPass</code> æä¾›äº†50å¤šä¸ª <code>check_*</code> æ–¹æ³•ã€‚æ¥ä¸‹æ¥ä¸€ä¸€è¯´æ˜è¿™äº›å®ã€‚</p>
<h4 id="builtincombinedearlylintpass-çš„å®å®šä¹‰"><a class="header" href="#builtincombinedearlylintpass-çš„å®å®šä¹‰">BuiltinCombinedEarlyLintPass çš„å®å®šä¹‰</a></h4>
<h5 id="early_lint_passes"><a class="header" href="#early_lint_passes">early_lint_passes</a></h5>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>macro_rules! early_lint_passes {
    ($macro:path, $args:tt) =&gt; {
        $macro!(
            $args,
            [
                UnusedParens: UnusedParens,
                UnusedBraces: UnusedBraces,
                UnusedImportBraces: UnusedImportBraces,
                UnsafeCode: UnsafeCode,
                AnonymousParameters: AnonymousParameters,
                EllipsisInclusiveRangePatterns: EllipsisInclusiveRangePatterns::default(),
                NonCamelCaseTypes: NonCamelCaseTypes,
                DeprecatedAttr: DeprecatedAttr::new(),
                WhileTrue: WhileTrue,
                NonAsciiIdents: NonAsciiIdents,
                HiddenUnicodeCodepoints: HiddenUnicodeCodepoints,
                IncompleteFeatures: IncompleteFeatures,
                RedundantSemicolons: RedundantSemicolons,
                UnusedDocComment: UnusedDocComment,
            ]
        );
    };
}
<span class="boring">}
</span></code></pre></pre>
<p>é¦–å…ˆæ˜¯ early_lint_passes å®ï¼Œè¿™ä¸ªå®çš„ä¸»è¦ä½œç”¨æ˜¯å®šä¹‰äº†æ‰€æœ‰çš„ early lintpassã€‚è¿™é‡Œçš„ lintpass æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œ<code>:</code>å·¦è¾¹ä¸º lintpass çš„ Identifierï¼Œ<code>:</code>å³è¾¹ä¸º lintpass çš„constructorã€‚æ‰€ä»¥ä¼šå‡ºç° <code>EllipsisInclusiveRangePatterns::default()</code> å’Œ <code>DeprecatedAttr::new()</code>è¿™ç§å½¢å¼ã€‚early_lint_passes ä¼šå°†å®šä¹‰çš„ early lintpass å’Œ ç¬¬äºŒä¸ªå‚æ•°ä¸€èµ·ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå®ã€‚
é€šè¿‡è¿™ä¸ªå®ï¼Œä¹‹å‰çš„<code>BuiltinCombinedEarlyLintPass</code>çš„å®šä¹‰è¢«å±•å¼€ä¸ºï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>declare_combined_early_pass!([BuiltinCombinedEarlyLintPass], [
                UnusedParens: UnusedParens,
                UnusedBraces: UnusedBraces,
                UnusedImportBraces: UnusedImportBraces,
                UnsafeCode: UnsafeCode,
                AnonymousParameters: AnonymousParameters,
                EllipsisInclusiveRangePatterns: EllipsisInclusiveRangePatterns::default(),
                NonCamelCaseTypes: NonCamelCaseTypes,
                DeprecatedAttr: DeprecatedAttr::new(),
                WhileTrue: WhileTrue,
                NonAsciiIdents: NonAsciiIdents,
                HiddenUnicodeCodepoints: HiddenUnicodeCodepoints,
                IncompleteFeatures: IncompleteFeatures,
                RedundantSemicolons: RedundantSemicolons,
                UnusedDocComment: UnusedDocComment,
            ])
<span class="boring">}
</span></code></pre></pre>
<h5 id="declare_combined_early_pass"><a class="header" href="#declare_combined_early_pass">declare_combined_early_pass</a></h5>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>macro_rules! declare_combined_early_pass {
    ([$name:ident], $passes:tt) =&gt; (
        early_lint_methods!(declare_combined_early_lint_pass, [pub $name, $passes]);
    )
}
<span class="boring">}
</span></code></pre></pre>
<p>declare_combined_early_pass å®æ¥æ”¶ early_lint_passeså®ä¼ æ¥çš„ name(BuiltinCombinedEarlyLintPass) å’Œ passesï¼Œå¹¶ç»§ç»­ä¼ é€’ç»™ early_lint_methods å®ã€‚
é€šè¿‡è¿™ä¸ªå®ï¼Œ<code>BuiltinCombinedEarlyLintPass</code>çš„å®šä¹‰ç»§ç»­å±•å¼€ä¸ºï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>early_lint_methods!(declare_combined_early_lint_pass, 
                    [pub BuiltinCombinedEarlyLintPass, 
                      [
                            UnusedParens: UnusedParens,
                            UnusedBraces: UnusedBraces,
                            UnusedImportBraces: UnusedImportBraces,
                            UnsafeCode: UnsafeCode,
                            AnonymousParameters: AnonymousParameters,
                            EllipsisInclusiveRangePatterns: EllipsisInclusiveRangePatterns::default(),
                            NonCamelCaseTypes: NonCamelCaseTypes,
                            DeprecatedAttr: DeprecatedAttr::new(),
                            WhileTrue: WhileTrue,
                            NonAsciiIdents: NonAsciiIdents,
                            HiddenUnicodeCodepoints: HiddenUnicodeCodepoints,
                            IncompleteFeatures: IncompleteFeatures,
                            RedundantSemicolons: RedundantSemicolons,
                            UnusedDocComment: UnusedDocComment,
               ]
                    ]);
<span class="boring">}
</span></code></pre></pre>
<h5 id="early_lint_methods"><a class="header" href="#early_lint_methods">early_lint_methods</a></h5>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>macro_rules! early_lint_methods {
    ($macro:path, $args:tt) =&gt; (
        $macro!($args, [
            fn check_param(a: &amp;ast::Param);
            fn check_ident(a: &amp;ast::Ident);
            fn check_crate(a: &amp;ast::Crate);
            fn check_crate_post(a: &amp;ast::Crate);
            ...
        ]);
    )
}
<span class="boring">}
</span></code></pre></pre>
<p>early_lint_methods å®åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­ä¹Ÿä»‹ç»è¿‡ï¼Œå®ƒå®šä¹‰äº† <code>EarlyLintPass</code> ä¸­éœ€è¦å®ç°çš„ <code>check_*</code>å‡½æ•°ï¼Œå¹¶ä¸”å°†è¿™äº›å‡½æ•°ä»¥åŠæ¥æ”¶çš„å‚æ•° <code>$args</code>ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå®ã€‚å› ä¸º <code>BuiltinCombinedEarlyLintPass</code> ä¹Ÿæ˜¯ early lint çš„ä¸€ç§ï¼Œæ‰€ä»¥åŒæ ·éœ€è¦å®ç°è¿™äº›å‡½æ•°ã€‚
é€šè¿‡è¿™ä¸ªå®ï¼Œ<code>BuiltinCombinedEarlyLintPass</code>çš„å®šä¹‰ç»§ç»­å±•å¼€ä¸ºï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>declare_combined_early_lint_pass!(
    [pub BuiltinCombinedEarlyLintPass, 
        [
            UnusedParens: UnusedParens,
            UnusedBraces: UnusedBraces,
            UnusedImportBraces: UnusedImportBraces,
            UnsafeCode: UnsafeCode,
            AnonymousParameters: AnonymousParameters,
            EllipsisInclusiveRangePatterns: EllipsisInclusiveRangePatterns::default(),
            NonCamelCaseTypes: NonCamelCaseTypes,
            DeprecatedAttr: DeprecatedAttr::new(),
            WhileTrue: WhileTrue,
            NonAsciiIdents: NonAsciiIdents,
            HiddenUnicodeCodepoints: HiddenUnicodeCodepoints,
            IncompleteFeatures: IncompleteFeatures,
            RedundantSemicolons: RedundantSemicolons,
            UnusedDocComment: UnusedDocComment,
        ]
    ],
    [
        fn check_param(a: &amp;ast::Param);
        fn check_ident(a: &amp;ast::Ident);
        fn check_crate(a: &amp;ast::Crate);
        fn check_crate_post(a: &amp;ast::Crate);
        ...
    ]
)
<span class="boring">}
</span></code></pre></pre>
<h5 id="declare_combined_early_lint_pass"><a class="header" href="#declare_combined_early_lint_pass">declare_combined_early_lint_pass</a></h5>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>macro_rules! declare_combined_early_lint_pass {
    ([$v:vis $name:ident, [$($passes:ident: $constructor:expr,)*]], $methods:tt) =&gt; (
        #[allow(non_snake_case)]
        $v struct $name {
            $($passes: $passes,)*
        }
        impl $name {
            $v fn new() -&gt; Self {
                Self {
                    $($passes: $constructor,)*
                }
            }
            $v fn get_lints() -&gt; LintArray {
                let mut lints = Vec::new();
                $(lints.extend_from_slice(&amp;$passes::get_lints());)*
                lints
            }
        }
        impl EarlyLintPass for $name {
            expand_combined_early_lint_pass_methods!([$($passes),*], $methods);
        }
        #[allow(rustc::lint_pass_impl_without_macro)]
        impl LintPass for $name {
            fn name(&amp;self) -&gt; &amp;'static str {
                panic!()
            }
        }
    )
}
<span class="boring">}
</span></code></pre></pre>
<p>declare_combined_early_lint_passå®æ˜¯ç”Ÿæˆ <code>BuiltinCombinedEarlyLintPass</code> çš„ä¸»ä½“ã€‚è¿™ä¸ªå®ä¸­åšäº†ä»¥ä¸‹å·¥ä½œï¼š</p>
<ul>
<li>ç”Ÿæˆä¸€ä¸ªåä¸º <code>BuiltinCombinedEarlyLintPass</code> çš„ structï¼Œå…¶ä¸­çš„å±æ€§ä¸ºå® <code>early_lint_passes</code> æä¾›çš„ lintpass çš„ identifierã€‚</li>
<li>å®ç° <code>fn new()</code> <code>fn name()</code> å’Œ <code>fn get_lints()</code> æ–¹æ³•ã€‚å…¶ä¸­ <code>new()</code> è°ƒç”¨äº† <code>early_lint_passes</code> æä¾›çš„ lintpass çš„ constructorã€‚</li>
<li>è°ƒç”¨å® <code>expand_combined_early_lint_pass_methods</code>ï¼Œå®ç°è‡ªèº«çš„ <code>check_*</code> æ–¹æ³•ã€‚</li>
</ul>
<p>é€šè¿‡è¿™ä¸ªå®ï¼Œ<code>BuiltinCombinedEarlyLintPass</code>çš„å®šä¹‰å˜ä¸ºï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct BuiltinCombinedEarlyLintPass {
            UnusedParens: UnusedParens,
            UnusedBraces: UnusedBraces,
            UnusedImportBraces: UnusedImportBraces,
            UnsafeCode: UnsafeCode,
            AnonymousParameters: AnonymousParameters,
            EllipsisInclusiveRangePatterns: EllipsisInclusiveRangePatterns,
            NonCamelCaseTypes: NonCamelCaseTypes,
            DeprecatedAttr: DeprecatedAttr,
            WhileTrue: WhileTrue,
            NonAsciiIdents: NonAsciiIdents,
            HiddenUnicodeCodepoints: HiddenUnicodeCodepoints,
            IncompleteFeatures: IncompleteFeatures,
            RedundantSemicolons: RedundantSemicolons,
            UnusedDocComment: UnusedDocComment,
}
impl BuiltinCombinedEarlyLintPass {
    pub fn new() -&gt; Self {
        Self {
            UnusedParens: UnusedParens,
            UnusedBraces: UnusedBraces,
            UnusedImportBraces: UnusedImportBraces,
            UnsafeCode: UnsafeCode,
            AnonymousParameters: AnonymousParameters,
            EllipsisInclusiveRangePatterns: EllipsisInclusiveRangePatterns::default(),
            NonCamelCaseTypes: NonCamelCaseTypes,
            DeprecatedAttr: DeprecatedAttr::new(),
            WhileTrue: WhileTrue,
            NonAsciiIdents: NonAsciiIdents,
            HiddenUnicodeCodepoints: HiddenUnicodeCodepoints,
            IncompleteFeatures: IncompleteFeatures,
            RedundantSemicolons: RedundantSemicolons,
            UnusedDocComment: UnusedDocComment,
        }
    }
    pub fn get_lints() -&gt; LintArray {
        let mut lints = Vec::new();
        lints.extend_from_slice(&amp;UnusedParens::get_lints());
        lints.extend_from_slice(&amp;UnusedBraces::get_lints());
        lints.extend_from_slice(&amp;UnusedImportBraces::get_lints());
        lints.extend_from_slice(&amp;UnsafeCode::get_lints());
        lints.extend_from_slice(&amp;AnonymousParameters::get_lints());
        lints.extend_from_slice(&amp;EllipsisInclusiveRangePatterns::get_lints());
        lints.extend_from_slice(&amp;NonCamelCaseTypes::get_lints());
        lints.extend_from_slice(&amp;DeprecatedAttr::get_lints());
        lints.extend_from_slice(&amp;WhileTrue::get_lints());
        lints.extend_from_slice(&amp;NonAsciiIdents::get_lints());
        lints.extend_from_slice(&amp;HiddenUnicodeCodepoints::get_lints());
        lints.extend_from_slice(&amp;IncompleteFeatures::get_lints());
        lints.extend_from_slice(&amp;RedundantSemicolons::get_lints());
        lints.extend_from_slice(&amp;UnusedDocComment::get_lints());
        
        lints
    }
}
impl EarlyLintPass for BuiltinCombinedEarlyLintPass {
    expand_combined_early_lint_pass_methods!([$($passes),*], $methods);
}
#[allow(rustc::lint_pass_impl_without_macro)]
impl LintPass for BuiltinCombinedEarlyLintPass {
    fn name(&amp;self) -&gt; &amp;'static str {
        panic!()
    }
}
<span class="boring">}
</span></code></pre></pre>
<h5 id="expand_combined_early_lint_pass_methods"><a class="header" href="#expand_combined_early_lint_pass_methods">expand_combined_early_lint_pass_methods</a></h5>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>macro_rules! expand_combined_early_lint_pass_methods {
    ($passes:tt, [$($(#[$attr:meta])* fn $name:ident($($param:ident: $arg:ty),*);)*]) =&gt; (
        $(fn $name(&amp;mut self, context: &amp;EarlyContext&lt;'_&gt;, $($param: $arg),*) {
            expand_combined_early_lint_pass_method!($passes, self, $name, (context, $($param),*));
        })*
    )
}
<span class="boring">}
</span></code></pre></pre>
<p>expand_combined_early_lint_pass_methodså®åœ¨ <code>BuiltinCombinedEarlyLintPass</code> ä¸­å±•å¼€æ‰€æœ‰ <code>early_lint_methods</code> ä¸­å®šä¹‰çš„æ–¹æ³•ã€‚
é€šè¿‡è¿™ä¸ªå®ï¼Œ<code>BuiltinCombinedEarlyLintPass</code>çš„å®šä¹‰å˜ä¸ºï¼ˆçœç•¥å…¶ä»–å®šä¹‰ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl EarlyLintPass for BuiltinCombinedEarlyLintPass {
    fn check_param(&amp;mut self, context: &amp;EarlyContext&lt;'_&gt;, a: &amp;ast::Param) {
        expand_combined_early_lint_pass_method!($passes, self, $name, (context, $($param),*));
    }
    fn check_ident(&amp;mut self, context: &amp;EarlyContext&lt;'_&gt;, a: &amp;ast::Ident) {
        expand_combined_early_lint_pass_method!($passes, self, $name, (context, $($param),*));
    }
    fn check_crate(&amp;mut self, context: &amp;EarlyContext&lt;'_&gt;, a: &amp;ast::Crate) {
        expand_combined_early_lint_pass_method!($passes, self, $name, (context, $($param),*));
    }
    ...
    
}
<span class="boring">}
</span></code></pre></pre>
<h5 id="expand_combined_early_lint_pass_method"><a class="header" href="#expand_combined_early_lint_pass_method">expand_combined_early_lint_pass_method</a></h5>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>macro_rules! expand_combined_early_lint_pass_method {
    ([$($passes:ident),*], $self: ident, $name: ident, $params:tt) =&gt; ({
        $($self.$passes.$name $params;)*
    })
}
<span class="boring">}
</span></code></pre></pre>
<p>expand_combined_early_lint_pass_methodï¼šåœ¨å±•å¼€çš„<code>check_*</code> å‡½æ•°ä¸­è°ƒç”¨æ¯ä¸€ä¸ª <code>LintPass</code> çš„ <code>check_*</code>ã€‚
é€šè¿‡è¿™ä¸ªå®ï¼Œ<code>BuiltinCombinedEarlyLintPass</code>çš„å®šä¹‰å˜ä¸ºï¼ˆçœç•¥å…¶ä»–å®šä¹‰ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl EarlyLintPass for BuiltinCombinedEarlyLintPass {
    fn check_param(&amp;mut self, context: &amp;EarlyContext&lt;'_&gt;, a: &amp;ast::Param) {
        self.UnusedParens.check_param(context, a);
        self.UnusedBraces.check_param(context, a);
        self.UnusedImportBraces.check_param(context, a);
        ...
    }
    fn check_ident(&amp;mut self, context: &amp;EarlyContext&lt;'_&gt;, a: &amp;ast::Ident) {
        self.UnusedParens.check_ident(context, a);
        self.UnusedBraces.check_ident(context, a);
        self.UnusedImportBraces.check_ident(context, a);
        ...
    }
    fn check_crate(&amp;mut self, context: &amp;EarlyContext&lt;'_&gt;, a: &amp;ast::Crate) {
        self.UnusedParens.check_crate(context, a);
        self.UnusedBraces.check_crate(context, a);
        self.UnusedImportBraces.check_crate(context, a);
        ...
    }
    ...
    
}
<span class="boring">}
</span></code></pre></pre>
<h4 id="builtincombinedearlylintpass-çš„æœ€ç»ˆå®šä¹‰"><a class="header" href="#builtincombinedearlylintpass-çš„æœ€ç»ˆå®šä¹‰">BuiltinCombinedEarlyLintPass çš„æœ€ç»ˆå®šä¹‰</a></h4>
<p>é€šè¿‡ä»¥ä¸Šå®çš„å±•å¼€ï¼Œ<code>BuiltinCombinedEarlyLintPass</code>çš„å®šä¹‰å®é™…ä¸ºå¦‚ä¸‹å½¢å¼ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct BuiltinCombinedEarlyLintPass {
    UnusedParens: UnusedParens,
    UnusedBraces: UnusedBraces,
    ...
}

impl BuiltinCombinedEarlyLintPass{
    pub fn new() -&gt; Self {
        UnusedParens: UnusedParens,
        UnusedBraces: UnusedBraces,
        ...
    }
    
    pub fn get_lints() -&gt; LintArray {
        let mut lints = Vec::new();
        lints.extend_from_slice(&amp;UnusedParens::get_lints());
        lints.extend_from_slice(&amp;UnusedBraces::get_lints());
        ...
        lints
    }
}

impl EarlyLintPass for BuiltinCombinedEarlyLintPass {
    fn check_crates(&amp;mut self, context: &amp;EarlyContext&lt;'_&gt;, a: &amp;ast::Crate){
        self.UnusedParens.check_crates (context, a);
        self.UnusedBraces.check_crates (context, a);
        ...
    }
    fn check_ident(&amp;mut self, context: &amp;EarlyContext&lt;'_&gt;, a: Ident){
        self.UnusedParens.check_ident (context, a);
        self.UnusedBraces.check_ident (context, a);
        ...
    }
    .. 
}
<span class="boring">}
</span></code></pre></pre>
<p>é€šè¿‡è¿™ä¸ªå®šä¹‰ï¼Œå¯ä»¥åœ¨éå† AST æ—¶ä½¿ç”¨ <code>BuiltinCombinedEarlyLintPass</code> çš„ <code>check_*</code> æ–¹æ³•å®ç°å¤šä¸ª lintpass çš„æ£€æŸ¥ã€‚</p>
<h2 id="lint-çš„è¿›ä¸€æ­¥ä¼˜åŒ–"><a class="header" href="#lint-çš„è¿›ä¸€æ­¥ä¼˜åŒ–">Lint çš„è¿›ä¸€æ­¥ä¼˜åŒ–</a></h2>
<p>åŸºäº CombinedLintPass ï¼Œå¯ä»¥å¯¹ä¹‹å‰æå‡ºçš„ Linter çš„è®¾è®¡åšè¿›ä¸€æ­¥ä¼˜åŒ–ã€‚
<img src="rustc/sema/lint/./images/combinedlintpass-01.jpg" alt="Linter" /></p>
<p>è¿™é‡Œï¼Œå¯ä»¥ç”¨ CombinedLintPass çš„<code>check_*</code> æ–¹æ³•ï¼Œåœ¨ Visitor éå† AST æ—¶æ‰§è¡Œå¯¹åº”çš„æ£€æŸ¥ã€‚è™½ç„¶æ•ˆæœä¸ä¹‹å‰ä¸€è‡´ï¼Œä½†å› ä¸ºå®çš„å…³ç³»ï¼Œæ‰€æœ‰çš„ <code>check_*</code> æ–¹æ³•å’Œéœ€è¦æ‰§è¡Œçš„ lintpass éƒ½è¢«æ”¶é›†åˆ°äº†ä¸€ä¸ªç»“æ„ä¸­ï¼Œä¹Ÿæ›´å®¹æ˜“ç®¡ç†ã€‚åŒæ ·çš„ï¼Œå› ä¸º CombinedLintPass å®é™…ä¸Šè°ƒç”¨çš„æ˜¯æ¯ä¸ª lintpass å„è‡ªçš„ check æ–¹æ³•ï¼Œè™½ç„¶è°ƒç”¨èµ·æ¥å¯èƒ½ä¸‹å›¾ä¸€æ ·å¾ˆå¤æ‚ï¼Œä½†å› ä¸º lintpass ä¸­å®šä¹‰çš„ check æ–¹æ³•å¤§éƒ¨åˆ†æ˜¯ç”±å®ç”Ÿæˆçš„ç©ºæ£€æŸ¥ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šé€ æˆæ€§èƒ½ä¸Šçš„æŸå¤±ã€‚
<img src="rustc/sema/lint/./images/combinedlintpass-02.jpg" alt="è°ƒç”¨å…³ç³»" /></p>
<h2 id="lint-çš„æ‰§è¡Œæµç¨‹"><a class="header" href="#lint-çš„æ‰§è¡Œæµç¨‹">Lint çš„æ‰§è¡Œæµç¨‹</a></h2>
<h2 id="rustc-ä¸­-lint-çš„æ‰§è¡Œé˜¶æ®µ"><a class="header" href="#rustc-ä¸­-lint-çš„æ‰§è¡Œé˜¶æ®µ">Rustc ä¸­ Lint çš„æ‰§è¡Œé˜¶æ®µ</a></h2>
<p>Rustc çš„è®¾è®¡ä¸ç»å…¸ç¼–è¯‘å™¨çš„è®¾è®¡åŸºæœ¬æ— å¼‚ï¼ŒåŒ…å«è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æã€ç”ŸæˆIRã€IRä¼˜åŒ–å’Œä»£ç ç”Ÿæˆç­‰æµç¨‹ï¼Œä½†é’ˆå¯¹ Rust çš„è¯­è¨€ç‰¹æ€§ï¼Œè¿˜åŠ å…¥äº†ä¸€äº›ç‰¹æœ‰çš„æµç¨‹ï¼Œå¦‚å€Ÿç”¨æ£€æŸ¥ã€‚å¯¹åº”çš„ï¼Œä»£ç åœ¨æ•´ä¸ªç¼–è¯‘æµç¨‹ä¸­çš„ä¸­é—´è¡¨ç¤ºä¹Ÿæœ‰ä¸€å®šçš„æ‰©å±•ï¼š</p>
<ul>
<li>Token streamï¼šLexer å°†æºä»£ç çš„å­—ç¬¦æµè½¬åŒ–ä¸ºè¯æ³•å•å…ƒï¼ˆtokenï¼‰ æµï¼Œè¿™äº›è¯æ³•å•å…ƒè¢«ä¼ é€’ç»™ä¸‹ä¸€ä¸ªæ­¥éª¤ï¼Œå³è¯­æ³•åˆ†æã€‚</li>
<li>Abstract Syntax Tree(AST)ï¼šParser å°† Token æµè½¬æ¢ä¸ºæŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰ï¼ŒæŠ½è±¡è¯­æ³•æ ‘å‡ ä¹å¯ä»¥å®Œå…¨æè¿°æºä»£ç ä¸­æ‰€å†™çš„å†…å®¹ã€‚åœ¨ AST ä¸Šï¼ŒRustc è¿˜æ‰§è¡Œäº†å®æ‰©å±•ã€ early lint ç­‰è¿‡ç¨‹ã€‚</li>
<li>High-level IR(HIR)ï¼šè¿™æ˜¯ä¸€ç§è„±ç³–çš„ ASTã€‚å®ƒä»ä¸æºä»£ç ä¸­çš„å†…å®¹éå¸¸æ¥è¿‘ï¼Œä½†å®ƒåŒ…å«ä¸€äº›éšå«çš„ä¸œè¥¿ï¼Œä¾‹å¦‚ä¸€äº›çœç•¥çš„ç”Ÿå‘½å‘¨æœŸç­‰ã€‚è¿™ä¸ª IR é€‚åˆç±»å‹æ£€æŸ¥ã€‚late lintä¹Ÿåœ¨ç±»å‹æ£€æŸ¥ä¹‹åè¿›è¡Œã€‚</li>
<li>Typed HIR(THIR)ï¼šTHIR ä¸ HIR ç±»ä¼¼ï¼Œä½†å®ƒæºå¸¦äº†ç±»å‹ä¿¡æ¯ï¼Œå¹¶ä¸”æ›´åŠ è„±ç³–ï¼ˆä¾‹å¦‚ï¼Œå‡½æ•°è°ƒç”¨å’Œéšå¼çš„é—´æ¥å¼•ç”¨éƒ½ä¼šå˜æˆå®Œå…¨æ˜¾å¼ï¼‰ã€‚</li>
<li>Middle-level IR(MIR)ï¼šMIR åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªæ§åˆ¶æµå›¾ï¼ˆControl-Flow Graphï¼‰ã€‚CFG æ˜¯ç¨‹åºæ‰§è¡Œè¿‡ç¨‹çš„æŠ½è±¡è¡¨ç°ï¼Œä»£è¡¨äº†ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šéå†åˆ°çš„æ‰€æœ‰è·¯å¾„ã€‚å®ƒç”¨å›¾çš„å½¢å¼è¡¨ç¤ºä¸€ä¸ªè¿‡ç¨‹å†…æ‰€æœ‰åŸºæœ¬å—å¯èƒ½æµå‘ã€‚Rustc åœ¨ MIR ä¸Šé™¤äº†åŸºç¡€çš„åŸºäº CFG çš„é™æ€åˆ†æå’Œ IR ä¼˜åŒ–å¤–ï¼Œè¿˜è¿›è¡Œäº† Rust ä¸­æ‰€æœ‰æƒçš„å€Ÿç”¨æ£€æŸ¥ã€‚</li>
<li>LLVM IRï¼šRustc çš„åç«¯é‡‡ç”¨äº† LLVMï¼Œå› æ­¤ï¼ŒRustc ä¼šå°† MIR è¿›ä¸€æ­¥è½¬åŒ–ä¸º LLVM IR å¹¶ä¼ é€’ç»™ LLVM åšè¿›ä¸€æ­¥ä¼˜åŒ–å’Œä»£ç ç”Ÿæˆçš„å·¥ä½œã€‚</li>
</ul>
<p>ä»¥ä¸Š Rust ä»£ç çš„ä¸­é—´è¡¨ç¤ºçš„è½¬åŒ–æµç¨‹ä¹Ÿåæ˜ äº† Rust æ•´ä¸ªç¼–è¯‘çš„æµç¨‹ï¼Œæ€»ç»“ä¸ºä¸€å¼ å›¾ï¼š
<img src="rustc/sema/lint/images/compiler_process.jpg" alt="ç¼–è¯‘æµç¨‹" />
Rustc ä¸­çš„ <code>rustc_driver::lib.rs</code> ä¸­æ§åˆ¶äº†ç¼–è¯‘æµç¨‹çš„å„ä¸ªé˜¶æ®µï¼š</p>
<pre><code class="language-bash">fn run_compiler(...) -&gt; interface::Result&lt;()&gt; {
    ...
    interface::run_compiler(config, |compiler| {
        let linker = compiler.enter(|queries| {
            ...
            queries.parse()?;   // lexer parse
            ...
            queries.expansion()?; // resolver
            ...
            queries.prepare_outputs()?;
            ...
            queries.global_ctxt()?; // ast -&gt; hir
            ...
            queries.ongoing_codegen()?;
            ...
            }
}
</code></pre>
<p>å‰é¢ä»‹ç»è¿‡ï¼ŒRustc ä¸­çš„ Lint åŒ…å« early å’Œ late ä¸¤ç§ï¼Œå®ƒä»¬åˆ†åˆ«åœ¨ AST -&gt; HIR å’Œ HIR -&gt; THIR ä¸¤ä¸ªé˜¶æ®µæ‰§è¡Œã€‚è¿™é‡Œæˆ‘ä»¬åŒæ ·ä»¥ <code>WhileTrue</code> è¿™ä¸ªä¾‹å­å»çœ‹ Lint ä»å®šä¹‰ã€åˆ°æ³¨å†Œï¼Œæœ€åæ‰§è¡Œçš„å®Œæ•´çš„æµç¨‹ã€‚åŒæ—¶ï¼Œ<code>WhileTrue</code> æ˜¯ builtin çš„ early lint å…¶ä¸­çš„ä¸€ç§ï¼Œè¢«åŒ…å«åœ¨ <code>BuiltinCombinedEarlyLintPass</code> ä¹‹ä¸­ã€‚</p>
<h3 id="å®šä¹‰"><a class="header" href="#å®šä¹‰">å®šä¹‰</a></h3>
<p>é¦–å…ˆæ˜¯ <code>WhileTrue</code>çš„ lint å’Œå¯¹åº”çš„ lintpass çš„å®šä¹‰ï¼Œå®ƒä»¬è¢«å®šä¹‰åœ¨  <code>rustc_lint/src/builtin.rs</code> ä¸­</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>declare_lint! {
    /// The `while_true` lint detects `while true { }`.
    ///
    /// ### Example
    ///
    /// ```rust,no_run
    /// while true {
    ///
    /// }
    /// ```
    ///
    /// {{produces}}
    ///
    /// ### Explanation
    ///
    /// `while true` should be replaced with `loop`. A `loop` expression is
    /// the preferred way to write an infinite loop because it more directly
    /// expresses the intent of the loop.
    WHILE_TRUE,
    Warn,
    &quot;suggest using `loop { }` instead of `while true { }`&quot;
}

declare_lint_pass!(WhileTrue =&gt; [WHILE_TRUE]);

impl EarlyLintPass for WhileTrue {
    fn check_expr(&amp;mut self, cx: &amp;EarlyContext&lt;'_&gt;, e: &amp;ast::Expr) {
      ...
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>ä¸å‰é¢çš„ä»‹ç»ä¸€æ ·ï¼š</p>
<ol>
<li><code>declare_lint</code> å®å£°æ˜ä¸€ä¸ª lintï¼š<code>WHILE_TRUE</code></li>
<li><code>declare_lint_pass</code> å®å£°æ˜ä¸€ä¸ªlintpassï¼š<code>WhileTrue</code></li>
<li>ä¸º <code>WhileTrue</code> å®ç° <code>EarlyLintPass</code> ä¸­å¯¹åº”çš„æ£€æŸ¥æ–¹æ³•ï¼Œå› ä¸ºæ­¤ lintpass åªæ£€æŸ¥ Expr èŠ‚ç‚¹ï¼Œæ‰€ä»¥åªéœ€è¦å®ç° <code>check_expr()</code>å‡½æ•°å³å¯ã€‚</li>
</ol>
<h3 id="æ³¨å†Œ"><a class="header" href="#æ³¨å†Œ">æ³¨å†Œ</a></h3>
<p>æ³¨å†Œæ˜¯æŒ‡ç¼–è¯‘è¿‡ç¨‹ä¸­å°† Lint åŠ å…¥åˆ° LintStore çš„è¿‡ç¨‹ã€‚<code>WhileTrue</code> ä¸éœ€è¦å•ç‹¬çš„æ³¨å†Œå’Œæ‰§è¡Œï¼Œå®ƒçš„æ£€æŸ¥æ–¹æ³•é€šè¿‡å®æ‰©å±•çš„æ–¹å¼å±•å¼€åˆ° <code>BuiltinCombinedEarlyLintPass</code> ä¸­ã€‚<code>BuiltinCombinedEarlyLintPass</code> çš„æ³¨å†Œå’Œæ‰§è¡Œéƒ½å‘ç”Ÿåœ¨ <code>queries.expansion()</code> å‡½æ•°ä¸­ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn expansion(
    &amp;self,
) -&gt; Result&lt;&amp;Query&lt;(Rc&lt;ast::Crate&gt;, Rc&lt;RefCell&lt;BoxedResolver&gt;&gt;, Lrc&lt;LintStore&gt;)&gt;&gt; {
    tracing::trace!(&quot;expansion&quot;);
    self.expansion.compute(|| {
        let crate_name = self.crate_name()?.peek().clone();
        // æ³¨å†Œ
        let (krate, lint_store) = self.register_plugins()?.take(); 
        let _timer = self.session().timer(&quot;configure_and_expand&quot;);
        let sess = self.session();
        let mut resolver = passes::create_resolver(
            sess.clone(),
            self.codegen_backend().metadata_loader(),
            &amp;krate,
            &amp;crate_name,
        );
        let krate = resolver.access(|resolver| {
            // æ‰§è¡Œ
            passes::configure_and_expand(sess, &amp;lint_store, krate, &amp;crate_name, resolver)
        })?;
        Ok((Rc::new(krate), Rc::new(RefCell::new(resolver)), lint_store))
    })
}
<span class="boring">}
</span></code></pre></pre>
<p>æ³¨å†Œçš„è¿‡ç¨‹ä¼šç”Ÿæˆå®šä¹‰çš„ lint çš„ç»“æ„å¹¶æ·»åŠ åˆ° <a href="https://rustc-dev-guide.rust-lang.org/diagnostics/lintstore.html">LintStore</a> ä¸­ã€‚Lint æ•´ä½“ä¸Šè¢«åˆ†ä¸º4ä¸ªç§ç±»ï¼špre-expansion, early, late,  late-moduleã€‚å°½ç®¡ Lint å¯¹åº”çš„ LintPass åœ¨ç¼–è¯‘æµç¨‹ä¸­æ‰§è¡Œçš„é˜¶æ®µä¸åŒï¼Œä½†æ³¨å†Œéƒ½æ˜¯å‘ç”Ÿåœ¨åŒä¸€ä¸ªé˜¶æ®µã€‚
Lint æ³¨å†Œè¿‡ç¨‹çš„å‡½æ•°è°ƒç”¨é“¾è·¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>rustc_driver::lib::run_compiler()</li>
<li>rustc_interface::queries::Queries.expansion()</li>
<li>rustc_interface::queries::Queries.register_plugins()</li>
<li>rustc_lint::lib::new_lint_store()</li>
<li>rustc_lint::lib::register_builtins()</li>
</ul>
<p>åœ¨è¿™é‡Œï¼Œé»˜è®¤çš„ç¼–è¯‘æµç¨‹ä¼šæ‰§è¡Œ else{} åˆ†æ”¯ä¸­çš„è¯­å¥ï¼ŒBuiltinCombinedEarlyLintPass::get_lints() ä¼šç”Ÿæˆ <code>WHILE_TRUE</code> å¹¶æ·»åŠ åˆ° LintStoreä¸­ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>if no_interleave_lints {
    pre_expansion_lint_passes!(register_passes, register_pre_expansion_pass);
    early_lint_passes!(register_passes, register_early_pass);
    late_lint_passes!(register_passes, register_late_pass);
    late_lint_mod_passes!(register_passes, register_late_mod_pass);
} else {
    store.register_lints(&amp;BuiltinCombinedPreExpansionLintPass::get_lints());
    store.register_lints(&amp;BuiltinCombinedEarlyLintPass::get_lints());
    store.register_lints(&amp;BuiltinCombinedModuleLateLintPass::get_lints());
    store.register_lints(&amp;BuiltinCombinedLateLintPass::get_lints());
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="æ‰§è¡Œ"><a class="header" href="#æ‰§è¡Œ">æ‰§è¡Œ</a></h3>
<p>ä¸åŒçš„ LintPass çš„æ‰§è¡Œè¿‡ç¨‹å‘ç”Ÿåœ¨ç¼–è¯‘è¿‡ç¨‹çš„ä¸åŒé˜¶æ®µï¼Œå…¶ä¸­ï¼Œ<code>BuiltinCombinedEarlyLintPass</code> æ‰§è¡Œè¿‡ç¨‹çš„å‡½æ•°è°ƒç”¨é“¾è·¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>rustc_driver::lib::run_compiler()</li>
<li>rustc_interface::queries::Queries.expansion()</li>
<li>rustc_interface::passes::configure_and_expand()</li>
<li>rustc_lint::early::check_ast_node()</li>
<li>rustc_lint::early::early_lint_node()</li>
</ul>
<p>é¦–å…ˆï¼Œåœ¨ configure_and_expand() å‡½æ•°ä¸­ï¼Œæ‰§è¡Œäº† pre-expansion å’Œ early ä¸¤ç§ lintpassã€‚æ³¨å†Œæ—¶ä½¿ç”¨äº† BuiltinCombinedEarlyLintPass::get_lints() æ–¹æ³•ç”Ÿæˆ lintsï¼Œè€Œè¿™é‡Œç”¨ BuiltinCombinedEarlyLintPass::new() æ–¹æ³•ç”Ÿæˆäº† lintpassã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn configure_and_expand(
    sess: &amp;Session,
    lint_store: &amp;LintStore,
    mut krate: ast::Crate,
    crate_name: &amp;str,
    resolver: &amp;mut Resolver&lt;'_&gt;,
) -&gt; Result&lt;ast::Crate&gt; {
    pre_expansion_lint(sess, lint_store, resolver.registered_tools(), &amp;krate, crate_name);
    ...
    sess.time(&quot;early_lint_checks&quot;, || {
        let lint_buffer = Some(std::mem::take(resolver.lint_buffer()));
        rustc_lint::check_ast_node(
            sess,
            false,
            lint_store,
            resolver.registered_tools(),
            lint_buffer,
            rustc_lint::BuiltinCombinedEarlyLintPass::new(),
            &amp;krate,
        )
    });
}
<span class="boring">}
</span></code></pre></pre>
<p>Lint çš„æ‰§è¡Œæœ€ç»ˆå‘ç”Ÿåœ¨ <code>rustc_lint::early::early_lint_node()</code> å‡½æ•°ä¸­ã€‚æ¯”è¾ƒ <code>early_lint_node()</code> å‡½æ•°å’Œ <code>CombinedLintPass</code> ä¸€èŠ‚æœ€åçš„ä¼ªä»£ç ï¼š</p>
<p><img src="rustc/sema/lint/images/early_lint_node.jpg" alt="early_lint_nodeä¸CombinedLintPass" /></p>
<p>å®ƒä»¬ä¹‹é—´æœ‰ä»¥ä¸‹çš„å¯¹åº”å…³ç³»ï¼š</p>
<ul>
<li>å‚æ•° pass æ˜¯ configure_and_expand() å‡½æ•°ä¸­æ–°å»ºçš„ BuiltinCombinedEarlyLintPassï¼Œå®ƒå¯¹åº” combinedlintpassã€‚</li>
<li>EarlyContextAndPass å°†  pass ä¸ context ä¿¡æ¯ç»„åˆåœ¨ä¸€èµ·ï¼Œå¹¶ä¸”å®ç°äº† visitorï¼Œå®ƒå¯¹åº” Linterã€‚</li>
<li>check_node.check(cx) è°ƒç”¨äº† cx.pass.check_crate() è¿›è¡Œ lint æ£€æŸ¥ï¼Œæ ¹æ® BuiltinCombinedEarlyLintPass çš„å®šä¹‰ï¼Œ è¿™ä¸ªå‡½æ•°ä¸­ä¼šè°ƒç”¨æ‰€æœ‰ builtin early lint çš„ check_crate() æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œ ast_visit::walk_crate() éå†å­èŠ‚ç‚¹ï¼Œå®ƒå¯¹åº”äº† visit_crate()ã€‚</li>
</ul>
<h2 id="no_interleave_lints"><a class="header" href="#no_interleave_lints">no_interleave_lints</a></h2>
<p>è™½ç„¶ Rustc ä¸­è€ƒè™‘æ€§èƒ½å› ç´ ï¼Œå°† LintPass ç»„åˆæˆ CombinedLintPassï¼Œä½†æä¾›äº†ä¸€äº›ç¼–è¯‘å‚æ•°å»é…ç½® Lintã€‚å…¶ä¸­ï¼ŒLint çš„æ³¨å†Œå’Œæ‰§è¡Œè¿‡ç¨‹ä¸­éƒ½ç”¨åˆ°äº† no_interleave_lints å‚æ•°ã€‚è¿™ä¸ªå‚æ•°é»˜è®¤ä¸º falseï¼Œè¡¨ç¤ºæ˜¯å¦å•ç‹¬æ‰§è¡Œæ¯ä¸€ä¸ª lintã€‚ç¼–è¯‘æ—¶å°†è¿™ä¸ªä¿®æ”¹è¿™ä¸ªå‚æ•°å°±å¯ä»¥å•ç‹¬æ³¨å†Œæ¯ä¸€ä¸ª lint ä»¥åŠå•ç‹¬æ‰§è¡Œ lintpassï¼Œè¿™æ ·çš„è®¾è®¡æä¾›äº†æ›´å¥½çš„çµæ´»æ€§å’Œè‡ªå®šä¹‰çš„èƒ½åŠ›ï¼ˆæ¯”å¦‚ï¼Œå¯ä»¥å¯¹æ¯ä¸€ä¸ª lint å•ç‹¬åš benchmarkï¼‰ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>if no_interleave_lints {
    pre_expansion_lint_passes!(register_passes, register_pre_expansion_pass);
    early_lint_passes!(register_passes, register_early_pass);
    late_lint_passes!(register_passes, register_late_pass);
    late_lint_mod_passes!(register_passes, register_late_mod_pass);
} else {
    store.register_lints(&amp;BuiltinCombinedPreExpansionLintPass::get_lints());
    store.register_lints(&amp;BuiltinCombinedEarlyLintPass::get_lints());
    store.register_lints(&amp;BuiltinCombinedModuleLateLintPass::get_lints());
    store.register_lints(&amp;BuiltinCombinedLateLintPass::get_lints());
}
<span class="boring">}
</span></code></pre></pre>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn check_ast_node&lt;'a&gt;(...) {
    if sess.opts.debugging_opts.no_interleave_lints {
        for (i, pass) in passes.iter_mut().enumerate() {
            buffered =
                sess.prof.extra_verbose_generic_activity(&quot;run_lint&quot;, pass.name()).run(|| {
                    early_lint_node(
                        sess,
                        !pre_expansion &amp;&amp; i == 0,
                        lint_store,
                        registered_tools,
                        buffered,
                        EarlyLintPassObjects { lints: slice::from_mut(pass) },
                        check_node,
                    )
                });
        }
    } else {
        buffered = early_lint_node(
            sess,
            !pre_expansion,
            lint_store,
            registered_tools,
            buffered,
            builtin_lints,
            check_node,
        );
        ...
    }
}
<span class="boring">}
</span></code></pre></pre>
<h2 id="æ€»ç»“"><a class="header" href="#æ€»ç»“">æ€»ç»“</a></h2>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±åˆ†æäº† Rustc ä¸­ä¸€ä¸ª Lint å®šä¹‰ã€å®ç°å¯¹åº”çš„æ£€æŸ¥(LintPass)ã€æ³¨å†Œã€æœ€ç»ˆæ‰§è¡Œçš„å®Œæ•´æµç¨‹ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨è¿™äº›å®ï¼Œå»å®šä¹‰æ–°çš„Lintå’ŒLintPass(Clippy ä¸­ä¹Ÿæ˜¯ä»¥ç›¸ä¼¼çš„æ–¹å¼)ã€‚å½“ç„¶ï¼ŒRustc ä¸­å…³äº Lint çš„éƒ¨åˆ†è¿œè¿œä¸æ­¢è¿™äº›ï¼Œæˆ‘åªæ˜¯åˆ†äº«äº†å…¶ä¸­æˆ‘èƒ½ç†è§£çš„ä¸€å°éƒ¨åˆ†ï¼Œå¸Œæœ›èƒ½å¤Ÿå¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬åœ¨ <a href="https://github.com/KusionStack/KCLVM">KCLVM</a> è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œä¹Ÿæœ‰å¯¹è¿™éƒ¨åˆ†å†…å®¹çš„åº”ç”¨ä¸å®è·µï¼Œå¯ä»¥åœ¨è¿™ä¸ª <a href="https://github.com/KusionStack/KCLVM/issues/109">Issue</a> å’Œ <a href="https://github.com/KusionStack/KCLVM/pull/160">PR</a> çœ‹åˆ°æ›´ä¸ºè¯¦ç»†çš„è®¾è®¡æ–¹æ¡ˆå’Œå…·ä½“å®ç°ï¼ŒåŒ…å«äº†visitoræ¨¡å¼ï¼Œlintã€lintpassã€combinedlintpassçš„å®šä¹‰ï¼Œåœ¨resolveré˜¶æ®µè°ƒç”¨lintæ£€æŸ¥ç­‰å®ç°ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä»£ç ç”Ÿæˆ"><a class="header" href="#ä»£ç ç”Ÿæˆ">ä»£ç ç”Ÿæˆ</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é€šç”¨ç»“æ„"><a class="header" href="#é€šç”¨ç»“æ„">é€šç”¨ç»“æ„</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-çš„é”™è¯¯ä¿¡æ¯è¾“å‡ºåŸç†æ¦‚è¿°"><a class="header" href="#rust-çš„é”™è¯¯ä¿¡æ¯è¾“å‡ºåŸç†æ¦‚è¿°">Rust çš„é”™è¯¯ä¿¡æ¯è¾“å‡ºåŸç†æ¦‚è¿°</a></h1>
<h2 id="1-èƒŒæ™¯"><a class="header" href="#1-èƒŒæ™¯">1. èƒŒæ™¯</a></h2>
<p>æœ€è¿‘åœ¨å‚ä¸ <a href="https://link.zhihu.com/?target=https%3A//github.com/KusionStack/kusion">KusionStack</a> å†…ç½®çš„é¢†åŸŸè¯­è¨€ â€”â€” <a href="https://link.zhihu.com/?target=https%3A//github.com/KusionStack/kclvm">KCL é…ç½®è¯­è¨€ç¼–è¯‘å™¨</a> çš„å¼€å‘ï¼Œéœ€è¦å¼€å‘ç¼–è¯‘å™¨çš„é”™è¯¯å¤„ç†æ¨¡å—ï¼Œç”±äº KCL ä½¿ç”¨ Rust å¼€å‘çš„ï¼Œå› æ­¤æ‰“ç®—æ¥å­¦å­¦ Rust è¯­è¨€çš„é”™è¯¯å¤„ç†æ¨¡å—æ˜¯æ€ä¹ˆåšçš„ã€‚</p>
<h2 id="2-ä»‹ç»"><a class="header" href="#2-ä»‹ç»">2. ä»‹ç»</a></h2>
<p>å•çº¯ä» Rustc æºç çš„ç›®å½•ç»“æ„ä¸­çœ‹ï¼ŒRustc ä¸­å…³äºé”™è¯¯å¤„ç†çš„éƒ¨åˆ†ä¸»è¦é›†ä¸­åœ¨ rustc_errors ã€rustc_error_codes å’Œ rustc_error_message ä¸‰ä¸ªç›®å½•ä¸‹ï¼Œä½†æ˜¯åœ¨çœ‹æºç çš„è¿‡ç¨‹ä¸­æˆ‘å‘ç°ç”±äº Rustc ä»£ç é‡å¤§ï¼Œå¹¶ä¸”é”™è¯¯å¤„ç†æ¨¡å—æ¶‰åŠåˆ°å¾ˆå¤šå…¶ä»–çš„æ¨¡å—ï¼Œå•çº¯çš„çœ‹è¿™ä¸‰ä¸ªç›®å½•ä¸‹çš„ä»£ç å¾ˆå®¹æ˜“çœ‹æ™•ï¼Œå‰–æèµ·æ¥ä¹Ÿæ¯”è¾ƒå›°éš¾ã€‚å› æ­¤ï¼Œæˆ‘æ‰“ç®—å°†è¿™éƒ¨åˆ†çš„çš„æºç å‰–ææ‹†åˆ†æˆå‡ ä¸ªéƒ¨åˆ†ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦ç»“åˆ<a href="https://rustc-dev-guide.rust-lang.org/"> Rustc çš„å®˜æ–¹æ–‡æ¡£</a>å’Œ<a href="https://github.com/rust-lang/rust"> Rustc æºç </a>è¿›è¡Œç»“æ„çš„æ¢³ç†ã€‚</p>
<p>å› æ­¤æœ¬æ–‡çš„æ ¸å¿ƒæ€è·¯åªæ˜¯å¯¹é”™è¯¯å¤„ç†éƒ¨åˆ†çš„ç»“æ„è¿›è¡Œæ¢³ç†ï¼Œç›®æ ‡å°±æ˜¯æ¢³ç†ä¸€ä¸‹åœ¨ Rustc å¯¹ Rust ç¨‹åºè¿›è¡Œè§£æçš„è¿‡ç¨‹ä¸­ï¼Œé”™è¯¯æ˜¯å¦‚ä½•ä»åˆ†æè¿‡ç¨‹ä¸€æ­¥ä¸€æ­¥ä¼ é€’åˆ°ç»ˆç«¯è¾“å‡ºæˆè¯Šæ–­ä¿¡æ¯çš„ã€‚å¯¹äºä¸€äº›å¤æ‚ä¸”ä¸é”™è¯¯è¯Šæ–­ä¿¡æ¯è¾“å‡ºæ— å…³çš„å†…å®¹ï¼Œæˆ‘ä»¬å…ˆæš‚ä¸”ç•¥è¿‡ä¸åšæ·±ç©¶ã€‚ç•™ä¸ªå‘åé¢å†å¡«ï¼Œå…ˆæŠŠç»“æ„æ¢³ç†æ¸…æ¥šï¼Œä¹Ÿæœ‰åŠ©äºæˆ‘ä»¬åç»­ä¸€æ­¥ä¸€æ­¥çš„å¯¹æºç è¿›è¡Œæ›´åŠ æ·±å…¥æ¸…æ™°çš„å‰–æï¼Œé˜²æ­¢æˆ‘ä»¬åœ¨ Rustc å¤§é‡çš„æºç ä¸­è¿·è·¯ã€‚å¹¶ä¸”ä¸ºäº†èƒ½æ›´åŠ æ¸…æ™°çš„çœ‹ä»£ç çš„ç»“æ„ï¼Œæœ¬æ–‡å¯¹ä½¿ç”¨çš„ä»£ç ç‰‡æ®µåšäº†å¤„ç†ï¼Œå»æ‰äº†ç”Ÿå‘½å‘¨æœŸç­‰ä¸ä»£ç æ‰§è¡Œé€»è¾‘æ— å…³çš„éƒ¨åˆ†ã€‚</p>
<h2 id="3-è¯Šæ–­ä¿¡æ¯é•¿å•¥æ ·"><a class="header" href="#3-è¯Šæ–­ä¿¡æ¯é•¿å•¥æ ·">3. è¯Šæ–­ä¿¡æ¯é•¿å•¥æ ·ï¼Ÿ</a></h2>
<p>é¦–å…ˆï¼Œçœ‹æºç ä¹‹å‰ï¼Œå…ˆçœ‹çœ‹ Rust çš„è¯Šæ–­ä¿¡æ¯çš„æ ¼å¼ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="rustc/general/errors/./images/error-01.png" alt="" /></p>
<p>æ ¹æ® Rustc æ–‡æ¡£ä¸­çš„æè¿°ï¼Œä¸Šè¿°ä¿¡æ¯å¯ä»¥åˆ†ä¸ºä¸‹é¢5ä¸ªéƒ¨åˆ†ï¼Œ</p>
<ul>
<li>
<p>Level ç­‰çº§ (é”™è¯¯ï¼Œè­¦å‘Šç­‰ç­‰)ï¼Œè¿™éƒ¨åˆ†ä¸»è¦ç”¨æ¥è¯´æ˜å½“å‰æ¶ˆæ¯çš„ä¸¥é‡ç¨‹åº¦ã€‚</p>
</li>
<li>
<p>Code ä»£ç æˆ–è€…ç¿»è¯‘æˆç¼–å·æ›´å¥½ä¸€äº› (ä¾‹å¦‚ï¼šå¯¹äºâ€œé”™è¯¯çš„ç±»å‹â€è¿™ç§è¯Šæ–­ä¿¡æ¯ï¼Œå®ƒå¯¹åº”çš„ç¼–å·æ˜¯E0308)ï¼Œè¿™ä¸ªç¼–å·æ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¿™ä¸ªç´¢å¼•æ‰¾åˆ°å½“å‰é”™è¯¯æ›´åŠ å®Œæ•´çš„æè¿°ä¿¡æ¯ã€‚é€šè¿‡ lint åˆ›å»ºçš„è¯Šæ–­ä¿¡æ¯æ²¡æœ‰è¿™ä¸ªç¼–å·ã€‚<br />
<strong>æ³¨ï¼šæˆ‘åé¢åˆæŸ¥äº†ä¸€ä¸‹ï¼Œrustc å®˜æ–¹æŠŠ Code ç§°ä½œ <a href="https://doc.rust-lang.org/error-index.html">Rust Compiler Error Index</a>ã€‚</strong></p>
</li>
<li>
<p>Message æ¶ˆæ¯ï¼Œæè¿°å½“å‰å‘ç”Ÿçš„é—®é¢˜çš„ä¸»è¦å†…å®¹ï¼Œè¿™ä¸ªæ¶ˆæ¯çš„å†…å®¹åº”è¯¥æ˜¯é€šç”¨çš„ç‹¬ç«‹çš„ï¼Œå³ä½¿æ²¡æœ‰å…¶ä»–å†…å®¹åªçœ‹è¿™ä¸€æ¡ä¿¡æ¯çš„è¯ï¼Œä¹Ÿèƒ½æœ‰æ‰€å¸®åŠ©ã€‚</p>
</li>
<li>
<p>Diagnostic Window è¯Šæ–­çª—å£ï¼Œä¸»è¦è´Ÿè´£å±•ç¤ºå‡ºç°é—®é¢˜çš„ä»£ç ä¸Šä¸‹æ–‡ç›¸å…³çš„ä¿¡æ¯ã€‚</p>
</li>
<li>
<p>Sub-diagnostic å­è¯Šæ–­ä¿¡æ¯ï¼Œä»»ä½•é”™è¯¯éƒ½æœ‰å¾ˆå¤šçš„å­è¯Šæ–­ä¿¡æ¯å¹¶ä¸”ä»–ä»¬çœ‹èµ·æ¥éƒ½å’Œè¯Šæ–­ä¿¡æ¯çš„ä¸»éƒ¨åˆ†ç›¸ä¼¼ã€‚</p>
</li>
</ul>
<h2 id="4-è¯Šæ–­ä¿¡æ¯ä»å“ªæ¥"><a class="header" href="#4-è¯Šæ–­ä¿¡æ¯ä»å“ªæ¥">4. è¯Šæ–­ä¿¡æ¯ä»å“ªæ¥ï¼Ÿ</a></h2>
<p>åœ¨äº†è§£äº† Rustc è¯Šæ–­ä¿¡æ¯ä¹‹åï¼Œæˆ‘ä»¬çœ‹ä¸‹ Rustc æ˜¯å¦‚ä½•æ„é€ è¿™æ ·çš„è¯Šæ–­ä¿¡æ¯çš„ã€‚åœ¨è¿™éƒ¨åˆ† Rustc å®˜æ–¹æä¾›äº†ä¸¤ç§æ–¹å¼ï¼Œ</p>
<ol>
<li>å®ç° rustc_sessions æä¾›çš„ traitã€‚</li>
<li>ç”¨ rustc_macros ä¸­ä¸ºè¾“å‡ºè¯Šæ–­ä¿¡æ¯å‡†å¤‡çš„å±æ€§å®ï¼Œè‡ªåŠ¨å®ç° rustc_sessions æä¾›çš„ traitã€‚</li>
</ol>
<p>ç›´æ¥çœ‹ä¸Šé¢è¿™ä¸¤ç‚¹ä¸å¤ªå¥½ç†è§£ï¼Œä¸»è¦çš„æµç¨‹å¯ä»¥å‚è€ƒä¸‹é¢è¿™å¼ å›¾ï¼Œ</p>
<p><img src="rustc/general/errors/./images/error-02.png" alt="" /></p>
<p>å…¶ä¸­ï¼Œé»„è‰²éƒ¨åˆ†è¡¨ç¤ºåœ¨ Rustc çš„ä¸åŒæ¨¡å—ä¸­ï¼Œå®šä¹‰å„è‡ªçš„é”™è¯¯/è­¦å‘Šç­‰å¼‚å¸¸ç±»å‹çš„ç»“æ„ä½“ Struct  (<strong>æ³¨ï¼šæšä¸¾ä¹Ÿå¯ä»¥ï¼Œæœ¬æ–‡æ˜¯ä¸€ä¸ªæ¦‚è¿°ï¼Œä¸ºäº†æ–¹ä¾¿æè¿°æ‰€ä»¥ä¸‹é¢å°±åªåˆ—Structäº†</strong>)ã€‚ç»¿è‰²éƒ¨åˆ†è¡¨ç¤ºåœ¨Rustcçš„é”™è¯¯å¤„ç†æ¨¡å—æä¾›äº†ä¸€ä¸ª trait SessionDiagnosticã€‚ä¸åŒæ¨¡å—å†…éƒ¨å®šä¹‰çš„ Struct å®ç°è¿™ä¸ª trait SessionDiagnosticã€‚trait SessionDiagnostic çš„å…·ä½“å®ç°å°±æ˜¯å°† Struct ä¸­è¾“å‡ºè¯Šæ–­ä¿¡æ¯éœ€è¦çš„å†…å®¹æŠ½å–å‡ºæ¥å°è£…å¥½ï¼Œè¿”å›ç»™ Rustc çš„é”™è¯¯å¤„ç†æ¨¡å—ç”¨æ¥è¾“å‡ºã€‚</p>
<p>è¿™å°±æ˜¯ä¸Šé¢æåˆ°çš„å®ç°é”™è¯¯æ¨¡å—æä¾›çš„ traitã€‚è¿™ä¸ª trait SessionDiagnostic çš„æºç å¦‚ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// rustc/compiler/rustc_session/src/session.rs
pub trait SessionDiagnostic
&lt;T: EmissionGuarantee = ErrorGuaranteed&gt; 
{
    fn into_diagnostic(
        self, 
        sess: &amp; ParseSess
    ) -&gt; DiagnosticBuilder&lt;T&gt;;
}
<span class="boring">}
</span></code></pre></pre>
<p>ä»¥ Rustc æ–‡æ¡£ä¸­ç»™å‡ºçš„é”™è¯¯ç»“æ„ä¸ºä¾‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct FieldAlreadyDeclared {
    pub field_name: Ident,
    pub span: Span,
    pub prev_span: Span,
}
<span class="boring">}
</span></code></pre></pre>
<p>æŒ‰ç…§ Rustc çš„å®˜æ–¹æè¿°ï¼Œè¦æƒ³è¾“å‡º struct FieldAlreadyDeclared å¯¹åº”çš„é”™è¯¯ä¿¡æ¯ï¼Œå°±è¦å®ç° trait SessionDiagnosticã€‚Rustc çš„æºç å†…éƒ¨å®šä¹‰çš„é”™è¯¯ç»“æ„ç›®å‰å®Œå…¨é‡‡ç”¨ç¬¬äºŒç§æ–¹å¼ã€‚</p>
<p>åœ¨ Rustc æä¾›çš„å®˜æ–¹æ–‡æ¡£ä¸Šï¼Œæä¾›äº† trait SessionDiagnostic çš„å…·ä½“å®ç°ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl SessionDiagnostic for FieldAlreadyDeclared {
    fn into_diagnostic(self, sess: Session) -&gt; DiagnosticBuilder {
        let mut diag = sess.struct_err(...);
        diag.set_span(self.span);
        diag.span_label(...);
        ... 
        diag
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>ä¸Šé¢ä»£ç å±•ç¤ºäº†å¦‚ä½•ä¸º Struct FieldAlreadyDeclared å®ç° trait SessionDiagnosticï¼Œå…·ä½“çš„ä»£ç ç»†èŠ‚çœ‹ä¸æ‡‚ä¹Ÿä¸ç”¨æ€¥ï¼Œè¿™é‡Œåªåšä¸€ä¸ªå±•ç¤ºï¼Œä»£ç çš„ç»†èŠ‚ä¸æ˜¯æˆ‘ä»¬æœ¬æ–‡çš„ä¸»é¢˜ï¼Œè¿‡æ—©çš„æ·±å…¥ä»£ç ç»†èŠ‚å®¹æ˜“è¿·è·¯ï¼Œåªè¦çŸ¥é“è¿™éƒ¨åˆ†ä»£ç ä» Struct FieldAlreadyDeclared æŠ½å–å‡ºäº†è¾“å‡ºè¯Šæ–­ä¿¡æ¯éœ€è¦çš„å†…å®¹ï¼Œå¹¶å°è£…åˆ°äº† DiagnosticBuilder ä¸­è¿”å›ã€‚</p>
<p>é‚£ä¹ˆæ€ä¹ˆç†è§£ç¬¬äºŒç§æ–¹å¼å‘¢ï¼Ÿä»¥ä¸Šé¢çš„ä»£ç ä¸ºä¾‹ï¼Œå®ç° trait SessionDiagnostic ä¸»è¦æ˜¯å°† Struct FieldAlreadyDeclared ä¸­éœ€è¦è¾“å‡ºåˆ°è¯Šæ–­ä¿¡æ¯ä¸­çš„å†…å®¹ï¼ŒæŠ½å–å‡ºæ¥ï¼Œå¡«å……åˆ° DiagnosticBuilder ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®å°±æ˜¯åœ¨æ¬ç –ï¼Œå°†ç»„æˆè¯Šæ–­ä¿¡æ¯çš„ç –å—ä» Struct FieldAlreadyDeclared æ¬è¿åˆ° DiagnosticBuilder ä¸­ï¼Œå› æ­¤ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥è‡ªåŠ¨åŒ–ï¼Œå½“æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–°çš„é”™è¯¯ Struct çš„æ—¶å€™ï¼Œç –å—ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±æ¬ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªç¨‹åºå¸®æˆ‘ä»¬æ¬ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å®šä¹‰ Struct çš„æ—¶å€™æ ‡æ³¨å‡ºæ¥å“ªäº›ç –éœ€è¦æ¬å°±å¯ä»¥äº†ã€‚</p>
<p>æ‰€ä»¥ï¼ŒRustc å†…éƒ¨é€šè¿‡å±æ€§å®çš„æ–¹å¼å†™å¥½äº†æ¬ç –çš„ç¨‹åºï¼Œè¿™ä¸ªæ¬ç –ç¨‹åºä¸ºæˆ‘ä»¬æä¾›äº†ä¸€äº›æ³¨è§£ï¼Œåœ¨å®šä¹‰æ–°çš„é”™è¯¯ Struct æ—¶ï¼Œåªéœ€è¦é€šè¿‡æ³¨è§£æ ‡æ³¨å‡ºå“ªäº›ç –è¦æ¬ï¼ŒRustc å†…éƒ¨çš„å±æ€§å®å°±ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨å®ç° trait SessionDiagnosticã€‚åŒæ ·æ˜¯ Struct FieldAlreadyDeclaredï¼Œä½¿ç”¨ç¬¬äºŒç§æ–¹å¼çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(SessionDiagnostic)]
#[diag(typeck::field_already_declared, code = &quot;E0124&quot;)]
pub struct FieldAlreadyDeclared {
    pub field_name: Ident,
    #[primary_span]
    #[label]
    pub span: Span,
    #[label(typeck::previous_decl_label)]
    pub prev_span: Span,
}
<span class="boring">}
</span></code></pre></pre>
<p>å…¶ä¸­ï¼Œé€šè¿‡æ³¨è§£ #[derive(SessionDiagnostic)] ä½¿ç”¨ rustc_sessions å†…éƒ¨å®ç°çš„å±æ€§å®ï¼Œé€šè¿‡æ³¨è§£[diag(typeck::field_already_declared, code = &quot;E0124&quot;)] è¯´æ˜å½“å‰è¯Šæ–­ä¿¡æ¯è¾“å‡ºçš„æ–‡æœ¬ä¿¡æ¯ä¸å‰é¢æåˆ°çš„å½“å‰è¯Šæ–­ä¿¡æ¯çš„ç¼–å·ï¼Œæœ€åé€šè¿‡æ³¨è§£ #[primary_span], #[label] å’Œ #[label(typeck::previous_decl_label)] æ³¨è§£æ ‡æ³¨äº†å‡ºç°é—®é¢˜çš„ä»£ç ä¸Šä¸‹æ–‡ç›¸å…³çš„ä¿¡æ¯ã€‚</p>
<p>å®šä¹‰äº†å¸¦æœ‰æ³¨è§£çš„ Struct æˆ–è€…ä¸º Struct å®ç°äº† trait SessionDiagnostic åï¼Œæ¥ä¸‹æ¥è¦åšä»€ä¹ˆï¼ŸRustc æ–‡æ¡£æ˜¯è¿™ä¹ˆè¯´çš„ã€‚</p>
<p><strong>Now that we've defined our diagnostic, how do we use it? It's quite straightforward, just create an instance of the struct and pass it to emit_err (or emit_warning).</strong></p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å®šä¹‰äº†æˆ‘ä»¬çš„è¯Šæ–­ä¿¡æ¯ï¼Œé‚£æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨å®ƒå‘¢ï¼Ÿè¿™éå¸¸ç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªç»“æ„ä½“çš„å®ä¾‹ï¼Œå¹¶å°†å®ƒä¼ é€’ç»™ emit_err() æˆ–è€… emit_warning() æ–¹æ³•å°±å¯ä»¥äº†ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>tcx.sess.emit_err(FieldAlreadyDeclared {
    field_name: f.ident,
    span: f.span,
    prev_span,
});
<span class="boring">}
</span></code></pre></pre>
<p>ä¸å¤ªæ˜ç™½ï¼Œä½†æ˜¯å¾—åˆ°äº†ä¸€ä¸ªå…³é”®æ–¹æ³• emit_err() ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•å°†é”™è¯¯çš„è¯Šæ–­ä¿¡æ¯è¾“å‡ºåˆ°ç»ˆç«¯ï¼Œé‚£å°±åœ¨æºç é‡Œå…¨å±€æœç´¢ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼š</p>
<p><img src="rustc/general/errors/./images/error-03.png" alt="" /></p>
<p>æ‰¾åˆ°äº†è¿™ä¸ªæ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// è¿™ä¸ªæ–¹æ³•åœ¨ Struct Session ä¸­ã€‚
impl Session{
    pub fn emit_err(
        &amp;self, 
        err: impl SessionDiagnostic
    ) -&gt; ErrorGuaranteed {
        self.parse_sess.emit_err(err)
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>æˆ‘ä»¬é¡ºç€æ–¹æ³•çš„è°ƒç”¨é“¾è·¯è¿ç»­ç‚¹è¿›å»çœ‹çœ‹ï¼Œ</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// self.parse_sess.emit_err(err)
impl ParseSess{
    pub fn emit_err(
        &amp;self, 
        err: impl SessionDiagnostic
    ) -&gt; ErrorGuaranteed {
        self.create_err(err).emit()
    }
}

// self.create_err(err)
impl ParseSess{
    pub fn create_err(
        &amp;'a self,
        err: impl SessionDiagnostic,
    ) -&gt; DiagnosticBuilder&lt;ErrorGuaranteed&gt; {
        err.into_diagnostic(self)
    }
}

// self.create_err(err).emit()
impl DiagnosticBuilder {
    pub fn emit(&amp;mut self) -&gt; G {
        ......
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>çœ‹ä»£ç å¥½åƒæ˜ç™½äº†ï¼ŒæŠŠä¸Šé¢é”™è¯¯å¤„ç†è¿‡ç¨‹çš„å›¾ç»†åŒ–ä¸€ä¸‹ï¼š</p>
<p><img src="rustc/general/errors/./images/error-05.png" alt="" /></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘åœ¨å›¾çš„å³é¢å¢åŠ äº†ä¸€äº›ä¸œè¥¿ï¼Œé»„è‰²çš„éƒ¨åˆ†æ²¡æœ‰å¤ªå¤§çš„å˜åŒ–ï¼ŒRustc å…¶ä»–çš„æ¨¡å—å®šä¹‰é”™è¯¯çš„ Structï¼Œç»¿è‰²çš„éƒ¨åˆ†å¢åŠ äº†ä¸€äº›å†…å®¹ï¼Œç»†åŒ–äº† trait SessionDiagnostic çš„ä¸»è¦å®ç°ï¼Œæ ¹æ®é»„è‰²çš„ Struct æä¾›çš„å†…å®¹ç”Ÿæˆè“è‰²çš„ DiagnosticBuilderã€‚ç”Ÿæˆçš„ DiagnosticBuilder ä¸­ï¼Œå†…ç½® emit() æ–¹æ³•ç”¨æ¥å°†è¯Šæ–­ä¿¡æ¯è¾“å‡ºåˆ°ç»ˆç«¯ï¼Œè¿™ä¸ª emit() æ–¹æ³•æœ€åä¼šåœ¨ Session ä¸­è¢«è°ƒç”¨ã€‚</p>
<p>åœ¨ rustc ä¸­é€šè¿‡ Struct Session è°ƒç”¨ç”Ÿæˆçš„ DiagnosticBuilder æ¥è¾“å‡ºè¯Šæ–­ä¿¡æ¯ï¼Œå…·ä½“çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸Šå›¾å³ä¾§æ‰€ç¤ºï¼ŒStruct Session å†…ç½®äº† Struct ParseSess ,è¿™é‡ŒåŒ…äº†ä¸¤å±‚ emit_err() æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨æ–¹æ³• ParseSess.emit_err() ä¸­ï¼Œè°ƒç”¨äº† ParseSess.create_err() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥å— trait SessionDiagnostic çš„å®ç°ï¼Œå¹¶è°ƒç”¨ trait SessionDiagnostic æä¾›çš„ into_diagnostic() æ–¹æ³•è·å– DiagnosticBuilder å®ä¾‹ï¼Œéšåè°ƒç”¨ DiagnosticBuilder å†…ç½®çš„ emit() æ–¹æ³•å°†è¯Šæ–­ä¿¡æ¯è¾“å‡ºåˆ°ç»ˆç«¯ã€‚</p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œé—®é¢˜åˆæ¥äº†ï¼ŒRustc é€šè¿‡ Session æ¥æ”¶ DiagnosticBuilder è¾“å‡ºè¯Šæ–­ä¿¡æ¯ï¼Œè¿™ä¸ª Session æ˜¯ä»€ä¹ˆï¼Ÿè¿™ä¸ª Session æ˜¯å¦‚ä½•ä¸ Rustc å…¶ä»–æ¨¡å—è”åŠ¨çš„å‘¢ï¼Ÿæˆ–è€…è¯´è¿™ä¸ª Session æ˜¯æ€ä¹ˆè¢«è°ƒç”¨çš„å‘¢ï¼Ÿ</p>
<p>å…³äº Session æ˜¯ä»€ä¹ˆï¼Œè¿™ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œä¸ºäº†é˜²æ­¢è¿·è·¯ï¼Œè¿™é‡Œå…ˆåˆ¨ä¸ªå‘ï¼Œåç»­çš„æ–‡ç« ä¸­çœ‹çœ‹ Session æ˜¯ä»€ä¹ˆï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ Session æ˜¯æ€ä¹ˆè¢«è°ƒç”¨æ¥å¤„ç†é”™è¯¯çš„ã€‚æˆ‘ä»¬åœ¨å…¨å±€æœç´¢ä¸€ä¸‹ sess.emit_err() è¿™ä¸ªå…³é”®å­—ï¼Œçœ‹çœ‹ rustc æ˜¯å¦‚ä½•é€šè¿‡ Session è¾“å‡ºè¯Šæ–­ä¿¡æ¯çš„ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨Rustcä¸­å¾ˆå¤šåœ°æ–¹éƒ½é€šè¿‡ Session è¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚</p>
<p><img src="rustc/general/errors/./images/error-04.png" alt="" /></p>
<p>æˆ‘çœ‹äº†ä¸€ä¸‹ï¼ŒæŒ‘äº†å‡ ä¸ªå…¶ä¸­æ¯”è¾ƒå…¸å‹ï¼Œè§åçŸ¥æ„çš„åœ°æ–¹ã€‚é¦–å…ˆæ˜¯åœ¨ Ructc çš„è¯­æ³•è§£æå™¨ rustc_parse ä¸­ï¼Œåœ¨è¿›è¡Œè¯­æ³•åˆ†æçš„è¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯ï¼Œä¼šé€šè¿‡ sess.emit_err() æ–¹æ³•è¾“å‡ºé”™è¯¯çš„è¯Šæ–­ä¿¡æ¯ã€‚</p>
<p><img src="rustc/general/errors/./images/error-06.png" alt="" /></p>
<p>ç„¶åï¼Œåœ¨ rustc çš„ç±»å‹æ£€æŸ¥å™¨ TypeChecker ä¸­ï¼Œæ‰€æœ‰æƒå€Ÿç”¨æ£€æŸ¥ rustc_borrowck éƒ¨åˆ†å’Œç±»å‹æ£€æŸ¥éƒ¨åˆ† rustc_typeck åœ¨æ£€æŸ¥åˆ°é”™è¯¯æ—¶ä¼šé€šè¿‡ sess.emit_err() æ–¹æ³•è¾“å‡ºé”™è¯¯çš„è¯Šæ–­ä¿¡æ¯ã€‚ä¸ rustc_parse ä¸åŒçš„æ˜¯ TypeChecker å¹¶ä¸ç›´æ¥å°† Session å®ä¾‹ä½œä¸ºç»“æ„ä½“æˆå‘˜è€Œæ˜¯é€šè¿‡ä¸€ä¸ªè·å–ä¸Šä¸‹æ–‡çš„æ–¹æ³• tcx() è·å– Session å®ä¾‹ã€‚</p>
<p><img src="rustc/general/errors/./images/error-07.png" alt="" />
<img src="rustc/general/errors/./images/error-08.png" alt="" /></p>
<p>è¿™ä¸ªä¸Šä¸‹æ–‡æ–¹æ³• tcx() çš„ç»†èŠ‚ä»¥åŠä¸Šä¸‹æ–‡çš„ç»“æ„ä¹Ÿæ˜¯æš‚ä¸æ·±ç©¶ï¼Œç›®å‰æˆ‘ä»¬åªéœ€è¦çŸ¥é“ TypeChecker ä¹Ÿæ˜¯é€šè¿‡ Session è¾“å‡ºè¯Šæ–­ä¿¡æ¯çš„å°±å¤Ÿäº†ã€‚ç„¶åï¼Œæˆ‘ä»¬æ¥æµ…çœ‹ä¸€ä¸‹ä»–ä»¬æ˜¯å¦‚ä½•å€ŸåŠ© Session è¾“å‡ºé”™è¯¯çš„ä¿¡æ¯çš„ã€‚</p>
<p>é¦–å…ˆï¼Œçœ‹çœ‹ rustc_parse ä¸­å…³äº Session çš„éƒ¨åˆ†ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Parser {
    pub sess: &amp; ParseSess,
	......
}

// åœ¨ Parser è§£æ Rust è¯­è¨€çš„æ—¶å€™,ä¼šè°ƒç”¨emit_erræ–¹æ³•è¾“å‡ºè¯Šæ–­ä¿¡æ¯ã€‚
self.sess.emit_err(...)
<span class="boring">}
</span></code></pre></pre>
<p>è§åçŸ¥æ„ç»™æˆ‘å¸¦æ¥äº†ä¸€ç‚¹è¯¯åˆ¤ï¼Œ Parser å†…ç½®çš„æ˜¯ ParseSess è€Œä¸æ˜¯ Sessionã€‚æ‰€ä»¥ï¼Œå¯ä»¥å€ŸåŠ©ä¸Šé¢é‚£ä¸ªå›¾çš„ç»“æ„ï¼Œç»™ Parser é”™è¯¯å¤„ç†çš„å±€éƒ¨ä¹Ÿå•ç‹¬ç”»ä¸€å¼ å›¾ã€‚</p>
<p><img src="rustc/general/errors/./images/error-09.png" alt="" /></p>
<p>ä¹‹å‰çš„å›¾ä¸­å·²ç»å±•ç¤ºäº†å†…éƒ¨çš„ç»†èŠ‚ï¼Œè¿™é‡Œå°±ä¸å±•ç¤ºäº†ï¼Œè¿™é‡Œåªå±•ç¤º trait SessionDiagnostic å’Œ Parser ä¹‹é—´çš„å…³ç³»ï¼Œ(<strong>æ³¨ï¼šä¸Šå›¾ä¸­çš„ Parse() æ–¹æ³•æ˜¯æˆ‘èµ·çš„åå­—ï¼ŒæŒ‡çš„æ˜¯ Rustcä¸­ å¯¹ Rust ç¨‹åºè¯­æ³•åˆ†æçš„è¿‡ç¨‹ï¼Œåœ¨ Rustc æºç¨‹åºä¸­è¿™ä¸ªæ–¹æ³•å¹¶ä¸ä¸€å®šå­˜åœ¨ï¼Œå…·ä½“ç”¨çš„æ˜¯ä»€ä¹ˆæ–¹æ³•ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œä½†æ˜¯åªè¦æ˜¯ç¼–è¯‘å™¨å°±ä¸€å®šæœ‰ parse è¿‡ç¨‹ï¼Œåœ¨ä¸åŒçš„ç¼–è¯‘å™¨ä¸­ parse è¿‡ç¨‹çš„åå­—å¯èƒ½ä¸åŒã€‚</strong>)</p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨å¯¹ Rust ç¨‹åºè¿›è¡Œè¯­æ³•åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‡ºç°é”™è¯¯ï¼Œå°±å®ä¾‹åŒ–ä¸€ä¸ªå®ç°äº† trait SessionDiagnostic çš„é”™è¯¯ Struct ç»“æ„ï¼Œå¹¶æŠŠå®ƒæŠ›ç»™ Parser å†…ç½®çš„ ParseSess ä¸­çš„ emit_err() æ–¹æ³•å°†è¯Šæ–­ä¿¡æ¯è¾“å‡ºã€‚</p>
<p>ç„¶åï¼Œå†çœ‹çœ‹ rustc_borrowck å’Œ rustc_typeckï¼Œä»è°ƒç”¨æ–¹å¼æ¥çœ‹ï¼Œä»–ä»¬ä¸æ˜¯ç›´æ¥å†…ç½® Session çš„ï¼Œä»–ä»¬åº”è¯¥æ˜¯å†…ç½®äº†ä¸€ä¸ªä¸Šä¸‹æ–‡ç›¸å…³çš„ç»“æ„ï¼Œç„¶åé‚£ä¸ªä¸Šä¸‹æ–‡ç›¸å…³çš„ç»“æ„ä¸­åŒ…å« Session ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>self.tcx().sess.emit_err(MoveUnsized { ty, span });
<span class="boring">}
</span></code></pre></pre>
<p>ç‚¹è¿› self çœ‹ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªç±»å‹æ£€æŸ¥å™¨ TypeChecker ï¼Œæ‰¾åˆ°ä¸Šä¸‹æ–‡ç»“æ„å¹¶ç‚¹è¿›å»æ·±åº¦ä¼˜å…ˆçš„æœç´¢ Session æˆ–è€… ParseSess ç»“æ„ï¼Œä¸ºäº†é˜²æ­¢å¤§å®¶çœ‹çš„æ—¶å€™è¿·è·¯ï¼Œæœç´¢è¿‡ç¨‹å°±ä¸å†™äº†ï¼Œè¿™é‡Œç›´æ¥å±•ç¤ºæœç´¢ç»“æœã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct TypeChecker {
    infcx: &amp; InferCtxt,
    ......
}

pub struct InferCtxt {
    pub tcx: TyCtxt,
    ......
}

pub struct TyCtxt {
    gcx: &amp; GlobalCtxt,
}


pub struct GlobalCtxt {
    pub sess: &amp; Session, // Session åœ¨è¿™é‡Œ
    ....
}
<span class="boring">}
</span></code></pre></pre>
<p>è—çš„å¤Ÿæ·±çš„ï¼Œä¸è¿‡å¥½åœ¨æˆ‘ä»¬è¿˜æ˜¯æŠŠå®ƒæŒ–äº†å‡ºæ¥ï¼Œç›®å‰èšç„¦äºé”™è¯¯å¤„ç†ï¼Œæ‰€ä»¥æš‚æ—¶ä¸ç”¨å…³å¿ƒè¿™äº›ä¸Šä¸‹æ–‡ç»“æ„ (XXXCtxt) éƒ½æ˜¯ä»€ä¹ˆæ„æ€ã€‚</p>
<p><img src="rustc/general/errors/./images/error-10.png" alt="" /></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸ Parser çš„éƒ¨åˆ†åŒç†ï¼Œty_check() æ˜¯æˆ‘è‡ªå·±å†™çš„æ–¹æ³•ï¼Œä»£æŒ‡ TypeChecker å¯¹ Rust ç¨‹åºè¿›è¡Œç±»å‹æ£€æŸ¥çš„è¿‡ç¨‹ï¼Œç›®å‰èšç„¦äºé”™è¯¯å¤„ç†ï¼Œæ‰€ä»¥ InferCtxtï¼ŒTyCtxt å’Œ GlobalCtxt ç­‰ä¸Šä¸‹æ–‡ç»“æ„æˆ‘å°±ç¼©å†™ä¸º XXXCtx äº†ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªè¿‡ç¨‹å’Œ Parser é”™è¯¯å¤„ç†çš„è¿‡ç¨‹æ˜¯ä¸€æ ·çš„ï¼Œåœ¨ç±»å‹æ£€æŸ¥çš„è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œå°±å®ä¾‹åŒ–ä¸€ä¸ªå®ç°äº† trait SessionDiagnostic çš„ç»“æ„ï¼Œå¹¶æŠŠå®ƒæŠ›ç»™ TypeChecker å†…ç½®çš„å„ç§ä¸Šä¸‹æ–‡ä¸­å†…ç½®çš„ Session ä¸­çš„ emit_err() æ–¹æ³•å°†è¯Šæ–­ä¿¡æ¯è¾“å‡ºã€‚</p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œå‹åŠ›æ¥åˆ°äº† Session å’Œ ParseSess è¿™è¾¹ï¼Œæ—¢ç„¶å¤§å®¶éƒ½æŠŠé”™è¯¯æŠ›ç»™ä»–ï¼Œé‚£å°±æ¥çœ‹çœ‹å®ƒé‡Œé¢å¹²äº†å•¥ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct Session {
    pub parse_sess: ParseSess,
	......
}

pub struct ParseSess {
    pub span_diagnostic: Handler,
	......
}
<span class="boring">}
</span></code></pre></pre>
<p>çœ‹ä¸å¤ªæ˜ç™½ï¼Œå†æŠŠä¹‹å‰çš„ä»£ç æ‹¿æ¥çœ‹çœ‹</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// self.parse_sess.emit_err(err)
impl ParseSess{
    pub fn emit_err(
        &amp; self, 
        err: impl SessionDiagnostic
    ) -&gt; ErrorGuaranteed {
        self.create_err(err).emit()
    }
}

// è¿™ä¸ªæ–¹æ³•æ˜¯ self.create_err(err)
impl ParseSess{
    pub fn create_err(
        &amp; self,
        err: impl SessionDiagnostic,
    ) -&gt; DiagnosticBuilder&lt;ErrorGuaranteed&gt; {
        err.into_diagnostic(self)
    }
}

// è¿™ä¸ªæ–¹æ³•æ˜¯ self.create_err(err).emit()
impl DiagnosticBuilder {
    pub fn emit(&amp;mut self) -&gt; G {
        ...... /// çœ‹æ¥ï¼Œæ˜¯æ—¶å€™æŠŠè¿™é‡Œçœç•¥çš„ä»£ç å±•å¼€äº†...
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>å±•å¼€ä¸Šè¿°ç¬¬21è¡Œçš„ä»£ç ï¼Œçœ‹åˆ°è¿™æ˜¯ä¸€ä¸ª trait çš„æŠ½è±¡æ¥å£ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;G: EmissionGuarantee&gt; DiagnosticBuilder&lt;G&gt; {
    pub fn emit(&amp;mut self) -&gt; G {
        // çœç•¥çš„ä»£ç 
        G::diagnostic_builder_emit_producing_guarantee(self)
}

// çœç•¥çš„ä»£ç æ˜¯ä¸€ä¸ªtraitçš„æŠ½è±¡æ¥å£ã€‚
pub trait EmissionGuarantee: Sized {
    fn diagnostic_builder_emit_producing_guarantee(
        db: &amp;mut DiagnosticBuilder
    ) -&gt; Self;
	...
}
<span class="boring">}
</span></code></pre></pre>
<p>ä¸ºäº†é˜²æ­¢è¿·è·¯ï¼Œå…ˆä¸æ·±ç©¶ EmissionGuarantee æ˜¯åšä»€ä¹ˆçš„ï¼Œåªå…³æ³¨ä»–æä¾›çš„è¾“å‡ºè¯Šæ–­ä¿¡æ¯åˆ°ç»ˆç«¯çš„åŠŸèƒ½å°±å¥½äº†ã€‚
ç„¶åï¼Œæˆ‘ä»¬åœ¨å…¨å±€æœç´¢ EmissionGuaranteeï¼Œæ‰¾ä¸€ä¸ª EmissionGuarantee çš„å®ç°ï¼Œçœ‹çœ‹ä»–æ˜¯å¦‚ä½•è¾“å‡ºä¿¡æ¯çš„ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl EmissionGuarantee for ErrorGuaranteed {
    fn diagnostic_builder_emit_producing_guarantee(
        db: &amp;mut DiagnosticBuilder&lt;Self&gt;
    ) -&gt; Self {
        match db.inner.state {
            DiagnosticBuilderState::Emittable(handler) =&gt; {
                ...
                let guar = handler.emit_diagnostic(&amp;mut db.inner.diagnostic);
            	...
            }
            DiagnosticBuilderState::AlreadyEmittedOrDuringCancellation =&gt; {
                ......
            }
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>çœ‹åˆ°ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘è§‰å¾—å‹åŠ›æ¥åˆ°äº† DiagnosticBuilder è¿™è¾¹ï¼Œæ¥éƒ½æ¥äº†ï¼Œå¾—çœ‹çœ‹ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// match db.inner.state

pub struct DiagnosticBuilder&lt;G: EmissionGuarantee&gt; {
    inner: DiagnosticBuilderInner,
    ...
}

struct DiagnosticBuilderInner {
    state: DiagnosticBuilderState,
    diagnostic: Box&lt;Diagnostic&gt;,
}

// match db.inner.state
enum DiagnosticBuilderState {
    Emittable(&amp; Handler),
    AlreadyEmittedOrDuringCancellation,
}
<span class="boring">}
</span></code></pre></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€åæ˜¯é€šè¿‡ DiagnosticBuilderState ä¸­çš„ Handler è¾“å‡ºå¾—è¯Šæ–­ä¿¡æ¯ã€‚</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// A handler deals with errors and other compiler output.
/// Certain errors (fatal, bug, unimpl) may cause immediate exit,
/// others log errors for later reporting.
pub struct Handler {
    flags: HandlerFlags,
    inner: Lock&lt;HandlerInner&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<p>åˆ° Handler è¿™é‡Œï¼Œçœ‹çœ‹æ³¨é‡Šï¼Œæˆ‘è§‰å¾—å¯ä»¥äº†ï¼Œæˆ‘ä»¬çŸ¥é“äº†æ‰€æœ‰é”™è¯¯çš„è¯Šæ–­ä¿¡æ¯ï¼Œæœ€åéƒ½é€šè¿‡ Handler è¾“å‡ºåˆ°ç»ˆç«¯ï¼Œåˆ°è¿™é‡Œï¼Œå¯ä»¥å†æŠŠä¸Šé¢çš„å›¾ç»†åŒ–ä¸€ä¸‹ï¼š</p>
<p><img src="rustc/general/errors/./images/error-11.png" alt="" /></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬åœ¨å›¾ä¸­å°† DiagnosticBuilder å†…éƒ¨çš„ä¸€ç‚¹ç‚¹ç»†èŠ‚ç”»è¿›å»äº†ï¼Œå…ˆä¸è€ƒè™‘ EmissionGuaranteeã€‚ DiagnosticBuilder ä¸­åŒ…å«è¾“å‡ºè¯Šæ–­ä¿¡æ¯çš„ Handler å’Œä¿å­˜è¯Šæ–­ä¿¡æ¯å†…å®¹çš„ Diagnostic ï¼Œåœ¨ Session å’Œ ParseSess ä¸­ï¼Œä¼šå…ˆè°ƒç”¨ SessionDiagnostic çš„ into_diagnostic() æ–¹æ³•ï¼Œè·å¾— DiagnosticBuilderï¼Œç„¶åè°ƒç”¨ DiagnoaticBuilder çš„ emit() æ–¹æ³•è¾“å‡ºè¯Šæ–­ä¿¡æ¯ï¼Œåœ¨ emit() æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ DiagnoaticBuilder å†…ç½®çš„ Handler å¹¶å°† DiagnoaticBuilder ä¸­çš„  Diagnostic è¾“å‡ºåˆ°ç»ˆç«¯ã€‚</p>
<h2 id="æ€»ç»“-1"><a class="header" href="#æ€»ç»“-1">æ€»ç»“</a></h2>
<p>åœ¨æœ¬æ–‡ä¸­æˆ‘ä»¬åªæ¶‰çŒäº† Rustc ä¸­é”™è¯¯å¤„ç†æ¨¡å—å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œé€šè¿‡è¿™ä¸€éƒ¨åˆ†çš„æµ…çœ‹ï¼Œæˆ‘ä»¬å¤§æ¦‚çš„äº†è§£äº†ä¸€ä¸‹ Rustc ä¸­é”™è¯¯ä»å‡ºç°åˆ°å˜æˆè¯Šæ–­ä¿¡æ¯è¾“å‡ºåˆ°ç»ˆç«¯çš„æ•´ä¸ªæµç¨‹ã€‚æœ€åä»¥ä¸Šæ–‡ä¸­æåˆ°çš„ rustc_parser å’Œ rustc_type_checker ä¸ºä¾‹ï¼Œä¸€å¼ å›¾æ”¶å°¾ã€‚</p>
<p><img src="rustc/general/errors/./images/error-12.png" alt="" /></p>
<p>Rustc é”™è¯¯å¤„ç†æ¨¡å—çš„ä¸‰éƒ¨åˆ†: </p>
<ul>
<li>ç¼–è¯‘å™¨çš„å„ä¸ªéƒ¨åˆ†è‡ªå®šä¹‰é”™è¯¯çš„ç»“æ„ï¼Œä¿å­˜é”™è¯¯ä¿¡æ¯ã€‚</li>
<li>SessionDiagnostic è´Ÿè´£å°†å„éƒ¨åˆ†è‡ªå®šä¹‰é”™è¯¯çš„ç»“æ„è½¬æ¢ä¸º DiagnosticBuilderã€‚</li>
<li>Session/ParseSess è´Ÿè´£è°ƒç”¨ SessionDiagnostic æä¾›çš„æ¥å£è·å¾— DiagnosticBuilder ï¼Œå¹¶è°ƒç”¨ DiagnosticBuilder å†…ç½®çš„æ–¹æ³•è¾“å‡ºè¯Šæ–­ä¿¡æ¯ã€‚</li>
</ul>
<p>å¦‚æœè¿˜æ˜¯æœ‰ä¸€ç‚¹ç»•æ™•äº†ï¼Œåœ¨ä¸Šé¢è¿™ä¸ªå›¾ä¸Šå†åŠ ä¸€ç¬”ï¼Œé€šè¿‡çº¢è‰²çš„å°–å¤´æˆ‘ä»¬å¯ä»¥çœ‹åˆ° Rust ä¸­çš„ä¸€ä¸ªå¼‚å¸¸åŒ…å«çš„ä¿¡æ¯çš„ä»å‘ç”Ÿé”™è¯¯çš„åœ°æ–¹åˆ°å¼€å‘è€…é¢å‰çš„ä¸»è¦æµå‘ï¼š</p>
<p><img src="rustc/general/errors/./images/error-13.png" alt="" /></p>
<p>ä»ä¸Šå›¾å³é¢çš„éƒ¨åˆ†å¯ä»¥çœ‹åˆ°ï¼Œé”™è¯¯ä¿¡æ¯å¹¶ä¸æ˜¯ç›´æ¥ä» DiagnosticBuilder ä¸­å‘é€åˆ°å¼€å‘è€…é¢å‰çš„ï¼Œè€Œæ˜¯å…ˆä» Session å…œäº†ä¸ªåœˆå­ï¼Œé‚£ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿè¿™é‡Œå…ˆåˆ¨ä¸ªå‘ï¼Œåç»­æˆ‘ä»¬å°†è¿›ä¸€æ­¥æ·±å…¥åˆ° Rustc çš„æºç å½“ä¸­å»ï¼Œè¯¦ç»†å‰–æè§£è¯»ä¸€ä¸‹å„éƒ¨åˆ†çš„æºç ç»“æ„å¹¶ä¸”ç†è§£ä¸€ä¸‹ Rustc çš„å¼€å‘è€…å¢åŠ å„ä¸ªéƒ¨åˆ†çš„åŠ¨æœºã€‚</p>
<h2 id="æœ¬æœŸæŒ–å‘"><a class="header" href="#æœ¬æœŸæŒ–å‘">æœ¬æœŸæŒ–å‘</a></h2>
<ul>
<li>Session å’Œ ParseSess åˆ°åº•æ˜¯ä»€ä¹ˆ ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆæœç´¢ emit_err() æ²¡æœ‰æ¶‰åŠåˆ°è¯æ³•åˆ†æ Lexer å’Œä»£ç ç”Ÿæˆ CodeGen çš„éƒ¨åˆ†ï¼Œè¿™ä¸¤ä¸ªéƒ¨åˆ†çš„é”™è¯¯æ˜¯æ€ä¹ˆå¤„ç†çš„ ï¼Ÿ</li>
<li>EmissionGuarantee è¿™ä¸ªç»“æ„åœ¨é”™è¯¯å¤„ç†çš„è¿‡ç¨‹ä¸­æ˜¯åšä»€ä¹ˆçš„ ï¼Ÿ</li>
</ul>
<h2 id="å‚è€ƒ"><a class="header" href="#å‚è€ƒ">å‚è€ƒ</a></h2>
<ul>
<li>KusionStack: <a href="https://github.com/KusionStack/kusion">https://github.com/KusionStack/kusion</a></li>
<li>KCL é…ç½®è¯­è¨€ç¼–è¯‘å™¨: <a href="https://github.com/KusionStack/KCLVM">https://github.com/KusionStack/KCLVM</a></li>
<li>Rustc å®˜æ–¹æ–‡æ¡£: <a href="https://rustc-dev-guide.rust-lang.org/">https://rustc-dev-guide.rust-lang.org/</a></li>
<li>Rustc æºç : <a href="https://github.com/rust-lang/rust">https://github.com/rust-lang/rust</a></li>
<li>Rust Compiler Error Index: <a href="https://doc.rust-lang.org/error-index.html">https://doc.rust-lang.org/error-index.html</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sourcemap--span"><a class="header" href="#sourcemap--span">SourceMap &amp; Span</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rustå¤–å›´å·¥å…·"><a class="header" href="#rustå¤–å›´å·¥å…·">Rustå¤–å›´å·¥å…·</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rustå¼€æºé¡¹ç›®"><a class="header" href="#rustå¼€æºé¡¹ç›®">Rustå¼€æºé¡¹ç›®</a></h1>
<ul>
<li><a href="https://awesome-kusion.github.io/rust-code-book/open-source/KCLVM/index.html">KCLVM</a></li>
<li><a href="open-source/open-source/KCLVM/readme.html">KCLVM</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="kclvm"><a class="header" href="#kclvm">KCLVM</a></h1>
<p>KCLVMï¼ˆKusion Configuration Language Virtual Machineï¼‰æ˜¯äº‘åŸç”Ÿå¯ç¼–ç¨‹æŠ€æœ¯æ ˆ Kusion çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼Œæ˜¯ KCL é…ç½®è¯­è¨€ç¼–è¯‘å™¨å‰åç«¯å®ç°çš„ç»Ÿç§°ï¼Œç”¨äºç¼–è¯‘ KCL é…ç½®æ–‡ä»¶å¹¶äº§ç”Ÿç›¸åº”çš„ YAML/JSON é…ç½®ã€‚æ­¤å¤– KCL æ˜¯ä¸€ç§ä¸“ç”¨äºé…ç½®å®šä¹‰ã€æ ¡éªŒçš„åŠ¨æ€å¼ºç±»å‹é…ç½®è¯­è¨€ï¼Œé‡ç‚¹æœåŠ¡äºäº‘åŸç”ŸåŸºç¡€è®¾æ–½é…ç½®å’Œç­–ç•¥å®šä¹‰åœºæ™¯ï¼Œå³åŸºç¡€è®¾æ–½ä»£ç åŒ– IaCï¼ˆInfrastructure as Codeï¼‰å’Œç­–ç•¥ä»£ç åŒ– PaCï¼ˆPolicy as Codeï¼‰ã€‚</p>
<h2 id="ä»‹ç»"><a class="header" href="#ä»‹ç»">ä»‹ç»</a></h2>
<p>Kusion é…ç½®è¯­è¨€ï¼ˆKCLï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„åŸºäºçº¦æŸçš„è®°å½•åŠå‡½æ•°è¯­è¨€ã€‚KCL é€šè¿‡æˆç†Ÿçš„ç¼–ç¨‹è¯­è¨€ç†è®ºå’Œå®è·µæ¥æ”¹è¿›å¯¹å¤§é‡ç¹æ‚çš„é…ç½®æ•°æ®å’Œé€»è¾‘çš„ç¼–å†™ï¼Œé€šè¿‡å£°æ˜å¼çš„è¯­æ³•ç»“åˆé™æ€ç±»å‹ç­‰æŠ€æœ¯ç‰¹æ€§æ¥ç®€åŒ–å’Œæ ¡éªŒé…ç½®çš„å¼€å‘å’Œè¿ç»´å·¥ä½œã€‚</p>
<h2 id="ç‰¹æ€§"><a class="header" href="#ç‰¹æ€§">ç‰¹æ€§</a></h2>
<ul>
<li><strong>è®¾è®¡ä¼˜è‰¯</strong>ï¼šç‹¬ç«‹è®¾è®¡çš„è¯­æ³•ã€è¯­ä¹‰ã€è¿è¡Œæ—¶å’Œç³»ç»Ÿåº“ï¼Œæä¾›é…ç½®ï¼ˆconfigï¼‰ã€ç±»å‹ï¼ˆschemaï¼‰ã€å‡½æ•°ï¼ˆlambdaï¼‰ã€è§„åˆ™ï¼ˆruleï¼‰ç­‰æ ¸å¿ƒè¯­è¨€å…ƒç´ </li>
<li><strong>å»ºæ¨¡èƒ½åŠ›</strong>ï¼šä»¥ Schema ä¸ºä¸­å¿ƒçš„å»ºæ¨¡æŠ½è±¡</li>
<li><strong>ä½¿ç”¨ç®€å•</strong>ï¼šè¯­è¨€è‡ªèº«è¦†ç›–å¤§å¤šæ•°é…ç½®å’Œç­–ç•¥åŠŸèƒ½</li>
<li><strong>å¯é </strong>ï¼šé™æ€ç±»å‹ç³»ç»Ÿå’Œè‡ªå®šä¹‰ Rule è§„åˆ™çº¦æŸ</li>
<li><strong>å¯æ‰©å±•</strong>ï¼šé…ç½®åˆ†å—å®šä¹‰èƒ½åŠ›åŠä¸°å¯Œçš„é…ç½®åˆå¹¶è¦†ç›–èƒ½åŠ›</li>
<li><strong>è‡ªåŠ¨åŒ–èƒ½åŠ›</strong>ï¼šä¸°å¯Œçš„è¯­è¨€çº§ CRUD API å’Œå¤šè¯­è¨€ API</li>
<li><strong>é«˜æ€§èƒ½</strong>ï¼šè¯­è¨€ç¼–è¯‘å™¨æœ¬èº«é‡‡ç”¨ Rust &amp; C å®ç°ï¼Œé…åˆ LLVM ä¼˜åŒ–å™¨ï¼Œæ”¯æŒç¼–è¯‘åˆ°æœ¬åœ°ä»£ç å’Œ WASM ç­‰æ ¼å¼å¹¶é«˜æ•ˆæ‰§è¡Œ</li>
<li><strong>äº‘åŸç”Ÿäº²å’Œ</strong>ï¼šåŸç”Ÿæ”¯æŒ <a href="https://github.com/KusionStack/kcl-openapi">OpenAPI</a> å’Œ Kubernetes CRD Specs åˆ° KCL çš„è½¬æ¢ï¼Œæ”¯æŒ Kubernetes YAML è§„èŒƒ</li>
<li><strong>å¼€å‘å‹å¥½</strong>ï¼šä¸°å¯Œçš„è¯­è¨€å·¥å…· (Lintï¼ŒTestï¼ŒVetï¼ŒDoc ç­‰)ã€ <a href="https://github.com/KusionStack/vscode-kcl">IDE æ’ä»¶</a>å’Œ<a href="https://github.com/KusionStack/kcl-plugin">è¯­è¨€æ’ä»¶</a></li>
</ul>
<h2 id="åœºæ™¯"><a class="header" href="#åœºæ™¯">åœºæ™¯</a></h2>
<p>æ‚¨å¯ä»¥å°† KCL ç”¨äº</p>
<ul>
<li>ç”Ÿæˆä½çº§é…ç½®æ•°æ®å¦‚ JSON, YAML ç­‰</li>
<li>ä½¿ç”¨ schema å¯¹é…ç½®æ•°æ®è¿›è¡Œå»ºæ¨¡å¹¶å‡å°‘é…ç½®æ•°æ®ä¸­çš„æ ·æ¿æ–‡ä»¶</li>
<li>ä¸ºé…ç½®æ•°æ®å®šä¹‰å¸¦æœ‰è§„åˆ™çº¦æŸçš„ schema å¹¶å¯¹æ•°æ®è¿›è¡Œè‡ªåŠ¨éªŒè¯</li>
<li>åˆ†å—ç¼–å†™é…ç½®æ•°æ®å¹¶ä½¿ç”¨ä¸åŒçš„ç­–ç•¥åˆå¹¶æ•°æ®</li>
<li>æ— å‰¯ä½œç”¨åœ°ç»„ç»‡ã€ç®€åŒ–ã€ç»Ÿä¸€å’Œç®¡ç†åºå¤§çš„é…ç½®</li>
<li>ä¸ <a href="https://kusionstack.io">Kusion Stack</a> ä¸€èµ·ï¼Œå®šä¹‰æ‚¨çš„åº”ç”¨äº¤ä»˜è¿ç»´ç”Ÿæ€</li>
</ul>
<h2 id="å®‰è£…"><a class="header" href="#å®‰è£…">å®‰è£…</a></h2>
<p>ä» Github releases é¡µé¢<a href="https://github.com/KusionStack/KCLVM/releases">ä¸‹è½½</a>ï¼Œå¹¶ä¸”å°† <code>{install-location}/kclvm/bin</code> æ·»åŠ åˆ°æ‚¨çš„ç¯å¢ƒå˜é‡ä¸­</p>
<h2 id="å¿«é€Ÿå¼€å§‹"><a class="header" href="#å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹</a></h2>
<p><code>./samples/fib.k</code> æ˜¯ä¸€ä¸ªè®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ä¾‹å­</p>
<pre><code class="language-kcl">schema Fib:
    n1: int = n - 1
    n2: int = n1 - 1
    n: int
    value: int
    if n &lt;= 1:
        value = 1
    elif n == 2:
        value = 1
    else:
        value = Fib {n: n1}.value + Fib {n: n2}.value
fib8 = Fib {n: 8}.value
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¾—åˆ° YAML è¾“å‡º</p>
<pre><code>kcl ./samples/fib.k
</code></pre>
<p>YAML è¾“å‡º</p>
<pre><code class="language-yaml">fib8: 21
</code></pre>
<h2 id="æ–‡æ¡£"><a class="header" href="#æ–‡æ¡£">æ–‡æ¡£</a></h2>
<p>æ›´å¤šæ–‡æ¡£è¯·è®¿é—® <a href="https://kusionstack.io">https://kusionstack.io</a></p>
<h2 id="è´¡çŒ®"><a class="header" href="#è´¡çŒ®">è´¡çŒ®</a></h2>
<p>å‚è€ƒ<a href="https://github.com/KusionStack/KCLVM/tree/main/docs/dev_guide">å¼€å‘æ‰‹å†Œ</a>.</p>
<h2 id="è·¯çº¿è§„åˆ’"><a class="header" href="#è·¯çº¿è§„åˆ’">è·¯çº¿è§„åˆ’</a></h2>
<p>å‚è€ƒ<a href="https://kusionstack.io/docs/governance/intro/roadmap#kclvm-%E8%B7%AF%E7%BA%BF%E8%A7%84%E5%88%92">KCLVM è·¯çº¿è§„åˆ’</a></p>
<h2 id="è®¸å¯"><a class="header" href="#è®¸å¯">è®¸å¯</a></h2>
<p>Apache License Version 2.0</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é™„å½•"><a class="header" href="#é™„å½•">é™„å½•</a></h1>


                        <!-- å…¬ä¼—å· -->
                        <hr>
                                                <div id="giscus-container"></div>
                        <footer class="page-footer">
                            <span>Â© 2022 | <a href="https://github.com/awesome-kusion/rust-code-book"> Rustæºç å‰–æä¸­æ–‡ç‰ˆ</a>, ä»…å­¦ä¹ äº¤æµä½¿ç”¨</span>
                        </footer>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>
        <script type="text/javascript" charset="utf-8">
        var pagePath = "print.md"
        </script>


        <!-- Custom JS scripts -->
                <script type="text/javascript" src="js/custom.js"></script>
                <script type="text/javascript" src="js/bigPicture.js"></script>
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
